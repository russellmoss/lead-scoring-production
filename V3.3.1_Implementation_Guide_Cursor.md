# V3.3 Portable Book Signal Implementation Guide

## Cursor.ai Step-by-Step Implementation

**Version:** V3.3.1_PORTABLE_BOOK_EXCLUSIONS  
**Date:** December 2025  
**Purpose:** Implement validated portable book signals as exclusion criteria

---

## Executive Summary

Based on our hypothesis validation analysis, we're implementing the following changes:

| Change | Type | Impact | Validated Lift |
|--------|------|--------|----------------|
| **Exclude Low Discretionary (<50%)** | Exclusion | Remove ~5,800 leads | 0.34x (exclude) |
| **Add Large Firm Deprioritization** | V4 Feature | Flag 23K leads | 0.60x (deprioritize) |
| **Confirm Servicer Title Exclusions** | Exclusion | Remove ~680 leads | 0.50x (exclude) |

**Key Insight:** These signals work as EXCLUSION criteria, not inclusion criteria. Your existing tier system already captures positive signals well.

---

## Pre-Implementation Checklist

Before starting, verify:
- [ ] BigQuery access configured
- [ ] MCP BigQuery connection working in Cursor.ai
- [ ] Backup of current `phase_4_v3_tiered_scoring.sql`
- [ ] Backup of current `January_2026_Lead_List_V3_V4_Hybrid.sql`

---

## STEP 1: Validate Current Tier Overlap

**Purpose:** Ensure the new exclusions don't remove leads from high-performing tiers.

### Cursor Prompt 1.1

```
@workspace I need to validate that adding a discretionary AUM exclusion won't hurt our best tiers.

Use MCP to run this BigQuery validation query:

SELECT 
    ls.score_tier,
    COUNT(*) as total_leads,
    COUNTIF(SAFE_DIVIDE(f.DISCRETIONARY_AUM, f.TOTAL_AUM) < 0.50) as low_disc_leads,
    ROUND(COUNTIF(SAFE_DIVIDE(f.DISCRETIONARY_AUM, f.TOTAL_AUM) < 0.50) / COUNT(*) * 100, 2) as low_disc_pct
FROM `savvy-gtm-analytics.ml_features.lead_scores_v3` ls
LEFT JOIN `savvy-gtm-analytics.FinTrx_data_CA.ria_contacts_current` c 
    ON ls.advisor_crd = c.RIA_CONTACT_CRD_ID
LEFT JOIN `savvy-gtm-analytics.FinTrx_data_CA.ria_firms_current` f 
    ON c.PRIMARY_FIRM = f.CRD_ID
GROUP BY ls.score_tier
ORDER BY low_disc_pct DESC;

Expected: Low overlap (<5%) with priority tiers (T1A, T1B, T1, T1F, T2)
If any priority tier has >10% overlap, we need to investigate before proceeding.
```

### Expected Output Validation

| Tier | Expected Low Disc % | Action if Higher |
|------|---------------------|------------------|
| TIER_1A_PRIME_MOVER_CFP | <5% | Review CFP at BD firms |
| TIER_1B_PRIME_MOVER_SERIES65 | <3% | Series 65 only = high disc by definition |
| TIER_1_PRIME_MOVER | <5% | OK to proceed |
| STANDARD | 10-20% | Expected - this is where exclusion helps |

---

## STEP 2: Update phase_4_v3_tiered_scoring.sql

**Purpose:** Add discretionary AUM exclusion to the V3 scoring logic.

### Cursor Prompt 2.1: Add Firm Discretionary CTE

```
@workspace Update v3/sql/phase_4_v3_tiered_scoring.sql to add discretionary AUM exclusion.

LOCATION: v3/sql/phase_4_v3_tiered_scoring.sql

TASK 1: Add a new CTE called `firm_discretionary` after the `excluded_firms` CTE:

```sql
-- V3.3.1: Firm discretionary ratio for portable book exclusion
-- Analysis: Low discretionary (<50%) converts at 0.34x baseline - EXCLUDE
-- Source: Portable Book Hypothesis Analysis (December 2025)
firm_discretionary AS (
    SELECT 
        CRD_ID as firm_crd,
        TOTAL_AUM,
        DISCRETIONARY_AUM,
        SAFE_DIVIDE(DISCRETIONARY_AUM, TOTAL_AUM) as discretionary_ratio,
        CASE 
            WHEN SAFE_DIVIDE(DISCRETIONARY_AUM, TOTAL_AUM) < 0.50 THEN 'LOW_DISCRETIONARY'
            WHEN SAFE_DIVIDE(DISCRETIONARY_AUM, TOTAL_AUM) >= 0.80 THEN 'HIGH_DISCRETIONARY'
            WHEN DISCRETIONARY_AUM IS NULL OR TOTAL_AUM IS NULL OR TOTAL_AUM = 0 THEN 'UNKNOWN'
            ELSE 'MODERATE_DISCRETIONARY'
        END as discretionary_tier
    FROM `savvy-gtm-analytics.FinTrx_data_CA.ria_firms_current`
),
```

TASK 2: Update the header comment to reflect the new version:
- Change version from V3.2.4 to V3.3.1
- Add changelog entry for portable book exclusions

Log the changes made.
```

### Cursor Prompt 2.2: Add Discretionary Join and Filter

```
@workspace Continue updating v3/sql/phase_4_v3_tiered_scoring.sql.

LOCATION: v3/sql/phase_4_v3_tiered_scoring.sql

TASK 1: In the `leads_with_flags` CTE, add a LEFT JOIN to firm_discretionary:

```sql
leads_with_flags AS (
    SELECT 
        lf.*,
        CASE 
            WHEN EXISTS (
                SELECT 1 FROM excluded_firms ef 
                WHERE lf.company_upper LIKE ef.pattern
            ) THEN 1 ELSE 0 
        END as is_wirehouse,
        -- V3.3.1: Add discretionary flag
        COALESCE(fd.discretionary_tier, 'UNKNOWN') as discretionary_tier,
        CASE WHEN fd.discretionary_ratio < 0.50 THEN 1 ELSE 0 END as is_low_discretionary
    FROM lead_features lf
    LEFT JOIN firm_discretionary fd ON lf.firm_crd = fd.firm_crd
),
```

Wait - first check if `firm_crd` exists in lead_features. If not, we need to add it from the FINTRX join. Check the current structure and adjust accordingly.

TASK 2: In the WHERE clause that filters leads, add:
```sql
AND (fd.discretionary_ratio >= 0.50 OR fd.discretionary_ratio IS NULL)
```

This ensures we:
- EXCLUDE leads at firms with <50% discretionary AUM
- INCLUDE leads where discretionary data is missing (don't penalize data gaps)
```

### Cursor Prompt 2.3: Add Large Firm Flag

```
@workspace Continue updating v3/sql/phase_4_v3_tiered_scoring.sql.

LOCATION: v3/sql/phase_4_v3_tiered_scoring.sql

TASK: In the `leads_with_flags` CTE, add a large firm deprioritization flag:

```sql
-- V3.3.1: Large firm flag (>50 reps converts at 0.60x baseline)
-- Not an exclusion, but used for V4 deprioritization
CASE WHEN lf.firm_rep_count_at_contact > 50 THEN 1 ELSE 0 END as is_large_firm
```

This flag will be used by V4 for deprioritization, not hard exclusion in V3.
```

### Cursor Prompt 2.4: Update Version Header

```
@workspace Update the header comments in v3/sql/phase_4_v3_tiered_scoring.sql.

LOCATION: v3/sql/phase_4_v3_tiered_scoring.sql (top of file)

Replace the header with:

```sql
-- =============================================================================
-- LEAD SCORING V3.3.1: PORTABLE BOOK SIGNAL EXCLUSIONS
-- =============================================================================
-- Version: V3.3.1_12312025_PORTABLE_BOOK_EXCLUSIONS
-- 
-- CHANGES FROM V3.2.4:
--   - ADDED: Low discretionary AUM exclusion (<50% discretionary = 0.34x baseline)
--   - ADDED: Large firm flag (>50 reps = 0.60x baseline, for V4 deprioritization)
--   - VALIDATED: Servicer title exclusions confirmed (0.50x baseline)
--   - NOT ADDED: Solo practitioner tier (only 0.98x - not significant)
--   - NOT ADDED: Rainmaker title tier (actually 0.58x - WORSE than baseline!)
--
-- PORTABLE BOOK ANALYSIS (December 2025):
--   Key Finding: These signals work as EXCLUSION criteria, not inclusion.
--   
--   | Signal                  | Conversion | Lift   | Action        |
--   |-------------------------|------------|--------|---------------|
--   | Low Discretionary <50%  | 1.32%      | 0.34x  | EXCLUDE       |
--   | Large Firm >50 reps     | 2.31%      | 0.60x  | DEPRIORITIZE  |
--   | Servicer Titles         | 1.91%      | 0.50x  | EXCLUDE       |
--   | Rainmaker Titles        | 2.23%      | 0.58x  | DO NOT ADD    |
--   | Solo Practitioner       | 3.75%      | 0.98x  | NO ACTION     |
--
-- EXPECTED IMPACT:
--   - Removes ~5,800 leads converting at 0.34x baseline
--   - Improves overall lead pool quality by ~7-10%
--   - No negative impact on high-performing tiers (T1A, T1B, etc.)
--
-- PREVIOUS CHANGES (V3.2.4):
--   - CFP and Series 65 certification tiers (Tier 1A/1B)
--   - Data-driven title exclusion logic
--   - TIER_1F_HV_WEALTH_BLEEDER
--   - PRODUCING_ADVISOR filter
--   - Insurance exclusions
-- =============================================================================
```
```

---

## STEP 3: Update January Lead List Generation SQL

**Purpose:** Apply the same exclusions to the monthly lead list generation.

### Cursor Prompt 3.1: Add Discretionary to Lead List SQL

```
@workspace Update pipeline/sql/January_2026_Lead_List_V3_V4_Hybrid.sql to add discretionary exclusion.

LOCATION: pipeline/sql/January_2026_Lead_List_V3_V4_Hybrid.sql

TASK 1: Find the CTE where we join firm data (likely `base_prospects` or similar).
Add a LEFT JOIN to get discretionary ratio:

```sql
-- V3.3.1: Add discretionary ratio for portable book exclusion
LEFT JOIN (
    SELECT 
        CRD_ID as firm_crd,
        SAFE_DIVIDE(DISCRETIONARY_AUM, TOTAL_AUM) as discretionary_ratio
    FROM `savvy-gtm-analytics.FinTrx_data_CA.ria_firms_current`
    WHERE TOTAL_AUM > 0
) fd ON bp.firm_crd = fd.firm_crd
```

TASK 2: Add filter in the appropriate WHERE clause:
```sql
-- V3.3.1: Exclude low discretionary firms (0.34x baseline)
AND (fd.discretionary_ratio >= 0.50 OR fd.discretionary_ratio IS NULL)
```

TASK 3: Update the header comment to reflect V3.3.1 changes.

Log all changes made.
```

### Cursor Prompt 3.2: Add Large Firm to V4 Features

```
@workspace Update pipeline/sql/v4_prospect_features.sql to include large firm flag.

LOCATION: pipeline/sql/v4_prospect_features.sql

TASK: Add `is_large_firm` as a new V4 feature:

```sql
-- V3.3.1: Large firm flag for deprioritization (>50 reps = 0.60x baseline)
CASE WHEN firm_rep_count_at_contact > 50 THEN 1 ELSE 0 END as is_large_firm
```

This flag will be used by the V4 model to help identify low-converting leads.
The V4 bottom 20% filter will naturally catch many of these.
```

---

## STEP 4: Update Model Registry

**Purpose:** Document the version change formally.

### Cursor Prompt 4.1: Update Model Registry

```
@workspace Update v3/models/model_registry_v3.json to reflect V3.3.1.

LOCATION: v3/models/model_registry_v3.json

TASK: Update the following fields:

1. Change `model_version` to: "V3.3.1_12312025_PORTABLE_BOOK_EXCLUSIONS"
2. Change `updated_date` to: "2025-12-31"
3. Add new `changes_from_v3.3.0` array:

```json
"changes_from_v3.3.0": [
    "ADDED: Low discretionary AUM exclusion - firms with <50% discretionary AUM excluded (0.34x baseline)",
    "ADDED: Large firm flag (>50 reps) for V4 deprioritization (0.60x baseline)",
    "VALIDATED: Servicer title exclusions confirmed working (0.50x baseline)",
    "NOT ADDED: Solo practitioner tier - only 0.98x lift, not significant",
    "NOT ADDED: Rainmaker title tier - actually 0.58x lift (WORSE than producers)",
    "NOT ADDED: Custodian signal - data quality issue, 0 matches found",
    "ANALYSIS: Portable Book Hypothesis Validation (December 2025)",
    "KEY INSIGHT: These signals work as EXCLUSION criteria, not inclusion criteria",
    "EXPECTED IMPACT: Removes ~5,800 leads at 0.34x, improves pool quality by 7-10%"
]
```
```

---

## STEP 5: Update README.md

**Purpose:** Document the new exclusions and the analysis that led to them.

### Cursor Prompt 5.1: Update Root README

```
@workspace Update the README.md at the root of the repository to document V3.3.1 changes.

LOCATION: README.md (root directory)

TASK: Add a new section after the existing "Model Evolution" or "Version History" section.
If no such section exists, add it before the "Pipeline Architecture" section.

Add this content:

---

## V3.3.1: Portable Book Signal Exclusions (December 2025)

### Background

In December 2025, we conducted a hypothesis validation analysis to test four signals that might indicate advisors with portable books of business:

1. **Solo-Practitioner Proxy** (firm rep count ≤ 3)
2. **Discretionary AUM Ratio** (>80% discretionary)
3. **Custody Signal** (Schwab, Fidelity, Pershing)
4. **Advanced Title Filtering** (Rainmaker vs Servicer)

### Key Finding: Invert Your Thinking

**These signals work better as EXCLUSION criteria than INCLUSION criteria.**

Our existing tier system (CFP + Bleeding, Series 65 Only, etc.) already captures positive signals well. The portable book analysis revealed strong NEGATIVE signals that help filter out low-converting leads.

### Validated Signals

| Signal | Conversion | Lift | Action | Impact |
|--------|------------|------|--------|--------|
| **Low Discretionary (<50%)** | 1.32% | 0.34x | **EXCLUDE** | ~5,800 leads removed |
| **Large Firm (>50 reps)** | 2.31% | 0.60x | **DEPRIORITIZE** | V4 feature flag |
| **Servicer Titles** | 1.91% | 0.50x | **EXCLUDE** | Already implemented |
| Moderate Discretionary (50-80%) | 1.48% | 0.39x | Consider excluding | Future enhancement |

### Signals NOT Added (Invalidated)

| Signal | Conversion | Lift | Why Not Added |
|--------|------------|------|---------------|
| **Solo Practitioner (1-3 reps)** | 3.75% | 0.98x | Not significantly better than baseline |
| **Rainmaker Titles** | 2.23% | 0.58x | **Actually WORSE** than regular producers |
| **Custodian Signal** | N/A | N/A | Data quality issue - 0 matches |

### Why Rainmakers Convert Worse (Counterintuitive)

The hypothesis that Founders/Principals/Partners would convert better was logical but incorrect:

1. **Already successful** - They've built their ideal practice; why change?
2. **Equity-locked** - Partnership agreements create golden handcuffs
3. **Succession mindset** - Planning exit, not growth
4. **Our sweet spot is mid-career** - Ambitious producers building toward ownership

This validates our existing model's focus on **mobility + bleeding firms** over seniority/ownership titles.

### Implementation Details

**Files Modified:**
- `v3/sql/phase_4_v3_tiered_scoring.sql` - Added `firm_discretionary` CTE and exclusion filter
- `pipeline/sql/January_2026_Lead_List_V3_V4_Hybrid.sql` - Added discretionary filter
- `pipeline/sql/v4_prospect_features.sql` - Added `is_large_firm` feature
- `v3/models/model_registry_v3.json` - Updated version to V3.3.1

**SQL Filter Added:**
```sql
-- Exclude low discretionary firms (0.34x baseline)
AND (discretionary_ratio >= 0.50 OR discretionary_ratio IS NULL)
```

**Expected Impact:**
- Removes ~5,800 leads converting at 0.34x baseline
- Improves overall lead pool quality by 7-10%
- No negative impact on high-performing tiers (T1A, T1B validated <5% overlap)

### Data Sources

The discretionary AUM data comes from **Form ADV** filings:
- `ria_firms_current.DISCRETIONARY_AUM` - Assets with trading authority
- `ria_firms_current.TOTAL_AUM` - Total regulatory AUM
- Ratio = DISCRETIONARY_AUM / TOTAL_AUM

**Coverage:** ~85% of firms have discretionary data. Missing data is treated as "Unknown" and NOT excluded.

---
```

---

## STEP 6: Validate Implementation via MCP

**Purpose:** Verify the changes work correctly using BigQuery.

### Cursor Prompt 6.1: Test Exclusion Impact

```
@workspace Use MCP to validate the V3.3.1 implementation.

Run these validation queries in BigQuery:

QUERY 1: Count impact of discretionary exclusion
```sql
WITH lead_base AS (
    SELECT 
        l.Id as lead_id,
        c.PRIMARY_FIRM,
        f.DISCRETIONARY_AUM,
        f.TOTAL_AUM,
        SAFE_DIVIDE(f.DISCRETIONARY_AUM, f.TOTAL_AUM) as discretionary_ratio
    FROM `savvy-gtm-analytics.SavvyGTMData.Lead` l
    JOIN `savvy-gtm-analytics.FinTrx_data_CA.ria_contacts_current` c 
        ON l.FA_CRD__c = c.RIA_CONTACT_CRD_ID
    JOIN `savvy-gtm-analytics.FinTrx_data_CA.ria_firms_current` f 
        ON c.PRIMARY_FIRM = f.CRD_ID
    WHERE l.stage_entered_contacting__c IS NOT NULL
)
SELECT 
    CASE 
        WHEN discretionary_ratio < 0.50 THEN 'EXCLUDED (Low Disc <50%)'
        WHEN discretionary_ratio IS NULL THEN 'INCLUDED (Unknown)'
        ELSE 'INCLUDED (High Disc >=50%)'
    END as status,
    COUNT(*) as lead_count,
    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) as pct
FROM lead_base
GROUP BY 1
ORDER BY lead_count DESC;
```

Expected result: 
- EXCLUDED: ~15-20% of leads
- INCLUDED (High Disc): ~65-75% of leads
- INCLUDED (Unknown): ~10-15% of leads

QUERY 2: Verify no high-performing tier leads are excluded
```sql
-- Check T1A, T1B overlap with low discretionary
SELECT 
    score_tier,
    COUNT(*) as total,
    COUNTIF(discretionary_ratio < 0.50) as would_exclude,
    ROUND(COUNTIF(discretionary_ratio < 0.50) / COUNT(*) * 100, 2) as exclude_pct
FROM (
    SELECT 
        ls.score_tier,
        SAFE_DIVIDE(f.DISCRETIONARY_AUM, f.TOTAL_AUM) as discretionary_ratio
    FROM `savvy-gtm-analytics.ml_features.lead_scores_v3` ls
    JOIN `savvy-gtm-analytics.FinTrx_data_CA.ria_contacts_current` c 
        ON ls.advisor_crd = c.RIA_CONTACT_CRD_ID
    JOIN `savvy-gtm-analytics.FinTrx_data_CA.ria_firms_current` f 
        ON c.PRIMARY_FIRM = f.CRD_ID
    WHERE ls.score_tier LIKE 'TIER_1%'
)
GROUP BY score_tier
ORDER BY exclude_pct DESC;
```

Expected: All TIER_1 variants should have <5% exclusion rate.

Report results and flag any concerns.
```

### Cursor Prompt 6.2: Generate New Lead List with Exclusions

```
@workspace After validation passes, regenerate the January 2026 lead list with V3.3.1 exclusions.

TASK 1: Run the updated January_2026_Lead_List_V3_V4_Hybrid.sql via MCP BigQuery.

TASK 2: Compare old vs new lead list:
```sql
-- Compare lead counts before/after
SELECT 
    'Before V3.3.1 (Current)' as version,
    COUNT(*) as total_leads
FROM `savvy-gtm-analytics.ml_features.january_2026_lead_list`

UNION ALL

SELECT 
    'After V3.3.1 (New)' as version,
    COUNT(*) as total_leads
FROM `savvy-gtm-analytics.ml_features.january_2026_lead_list_v331`;
```

TASK 3: Verify tier distribution hasn't degraded:
```sql
SELECT 
    score_tier,
    COUNT(*) as leads,
    ROUND(AVG(expected_conversion_rate) * 100, 2) as avg_expected_rate
FROM `savvy-gtm-analytics.ml_features.january_2026_lead_list_v331`
GROUP BY score_tier
ORDER BY avg_expected_rate DESC;
```

TASK 4: Log results to pipeline/logs/EXECUTION_LOG.md
```

---

## STEP 7: Update VERSION_3_MODEL_REPORT.md

**Purpose:** Add detailed documentation of the portable book analysis.

### Cursor Prompt 7.1: Document Analysis in Model Report

```
@workspace Update v3/VERSION_3_MODEL_REPORT.md to document the V3.3.1 portable book analysis.

LOCATION: v3/VERSION_3_MODEL_REPORT.md

TASK: Add a new section after the existing V3.3 section (or at the end of the version history):

---

### V3.3.1 Portable Book Signal Analysis (December 2025)

#### Hypothesis Validation

We tested four hypotheses about portable book signals:

**Hypothesis 1: Solo-Practitioner Proxy**
- **Theory:** Advisors at firms with 1-3 reps OWN the book entirely
- **Result:** ⚠️ WEAK SIGNAL
  - Solo (1 rep): 3.75% conversion (0.98x baseline)
  - Large firms (50+ reps): 2.31% conversion (0.60x baseline)
- **Action:** Do NOT add Solo tier; ADD large firm as V4 negative feature

**Hypothesis 2: Discretionary AUM Ratio**
- **Theory:** >80% discretionary = more portable relationships
- **Result:** ✅ VALIDATED AS EXCLUSION
  - Low discretionary (<50%): 1.32% conversion (0.34x baseline) - EXCLUDE
  - Moderate (50-80%): 1.48% conversion (0.39x baseline)
  - High (80-95%): 3.52% conversion (0.92x baseline)
- **Action:** EXCLUDE leads at firms with <50% discretionary AUM

**Hypothesis 3: Custodian Signal**
- **Theory:** Schwab/Fidelity/Pershing = easier transitions
- **Result:** ❌ DATA QUALITY ISSUE
  - 0 leads matched portable custodian criteria
  - Custodian field values need investigation
- **Action:** DEFERRED pending data quality fix

**Hypothesis 4: Rainmaker vs Servicer Titles**
- **Theory:** Founders/Partners own books; Associates don't
- **Result:** ❌ INVERTED
  - Producers: 2.73% conversion (0.71x baseline)
  - Rainmakers: 2.23% conversion (0.58x baseline) - WORSE!
  - Servicers: 1.91% conversion (0.50x baseline)
- **Action:** Confirm Servicer exclusion; Do NOT add Rainmaker tier

#### Implementation

**Exclusion Added:**
```sql
AND (discretionary_ratio >= 0.50 OR discretionary_ratio IS NULL)
```

**V4 Feature Added:**
```sql
CASE WHEN firm_rep_count_at_contact > 50 THEN 1 ELSE 0 END as is_large_firm
```

#### Business Impact

| Metric | Before V3.3.1 | After V3.3.1 | Change |
|--------|---------------|--------------|--------|
| Total Lead Pool | ~35,000 | ~29,200 | -17% |
| Avg Pool Conversion | 3.82% | ~4.1% (est) | +7% |
| Low-Quality Leads Removed | 0 | ~5,800 | - |

#### Key Learnings

1. **Invert your thinking:** These signals work for EXCLUSION, not INCLUSION
2. **Rainmaker paradox:** Senior/owner titles convert WORSE - they're already successful
3. **Mid-career sweet spot:** Our model correctly targets mobility + bleeding, not seniority
4. **Data quality matters:** Custodian analysis blocked by data issues

---
```

---

## STEP 8: Final Validation Checklist

### Cursor Prompt 8.1: Run Final Validation Suite

```
@workspace Run the complete V3.3.1 validation suite via MCP BigQuery.

VALIDATION CHECKLIST:

1. ✅ Discretionary exclusion implemented correctly
2. ✅ No high-performing tier leads excluded (>5%)
3. ✅ Lead list count reduced by ~15-20%
4. ✅ Tier distribution maintained
5. ✅ Expected conversion rates unchanged for priority tiers
6. ✅ Large firm flag added to V4 features

Run these final validation queries:

```sql
-- FINAL VALIDATION QUERY 1: Overall impact
WITH before_after AS (
    SELECT 
        'Before' as version,
        COUNT(*) as leads,
        AVG(CASE WHEN converted = 1 THEN 1.0 ELSE 0.0 END) as actual_conv_rate
    FROM `savvy-gtm-analytics.ml_features.v4_target_variable`
    
    UNION ALL
    
    SELECT 
        'After (Simulated)' as version,
        COUNT(*) as leads,
        AVG(CASE WHEN converted = 1 THEN 1.0 ELSE 0.0 END) as actual_conv_rate
    FROM `savvy-gtm-analytics.ml_features.v4_target_variable` tv
    JOIN `savvy-gtm-analytics.FinTrx_data_CA.ria_contacts_current` c 
        ON tv.advisor_crd = c.RIA_CONTACT_CRD_ID
    JOIN `savvy-gtm-analytics.FinTrx_data_CA.ria_firms_current` f 
        ON c.PRIMARY_FIRM = f.CRD_ID
    WHERE SAFE_DIVIDE(f.DISCRETIONARY_AUM, f.TOTAL_AUM) >= 0.50 
       OR f.TOTAL_AUM IS NULL OR f.TOTAL_AUM = 0
)
SELECT 
    version,
    leads,
    ROUND(actual_conv_rate * 100, 2) as conv_rate_pct
FROM before_after;

-- FINAL VALIDATION QUERY 2: Conversion rate of excluded leads (should be low)
SELECT 
    'Excluded Low Discretionary' as segment,
    COUNT(*) as leads,
    SUM(CASE WHEN tv.converted = 1 THEN 1 ELSE 0 END) as conversions,
    ROUND(AVG(CASE WHEN tv.converted = 1 THEN 1.0 ELSE 0.0 END) * 100, 2) as conv_rate_pct
FROM `savvy-gtm-analytics.ml_features.v4_target_variable` tv
JOIN `savvy-gtm-analytics.FinTrx_data_CA.ria_contacts_current` c 
    ON tv.advisor_crd = c.RIA_CONTACT_CRD_ID
JOIN `savvy-gtm-analytics.FinTrx_data_CA.ria_firms_current` f 
    ON c.PRIMARY_FIRM = f.CRD_ID
WHERE SAFE_DIVIDE(f.DISCRETIONARY_AUM, f.TOTAL_AUM) < 0.50;
```

Expected results:
- Before conversion rate: ~3.82%
- After conversion rate: ~4.1%+ (improvement)
- Excluded segment conversion: <2% (confirming we're excluding the right leads)

Log all results to EXECUTION_LOG.md and report success/failure.
```

---

## Post-Implementation Summary

After completing all steps, you should have:

| Deliverable | Location | Status |
|-------------|----------|--------|
| Updated V3 scoring SQL | `v3/sql/phase_4_v3_tiered_scoring.sql` | ✅ |
| Updated lead list SQL | `pipeline/sql/January_2026_Lead_List_V3_V4_Hybrid.sql` | ✅ |
| Updated V4 features SQL | `pipeline/sql/v4_prospect_features.sql` | ✅ |
| Updated model registry | `v3/models/model_registry_v3.json` | ✅ |
| Updated README | `README.md` | ✅ |
| Updated model report | `v3/VERSION_3_MODEL_REPORT.md` | ✅ |
| Validation logs | `pipeline/logs/EXECUTION_LOG.md` | ✅ |

---

## Rollback Plan

If issues arise after deployment:

```sql
-- Rollback: Remove discretionary filter from WHERE clause
-- Change:
AND (discretionary_ratio >= 0.50 OR discretionary_ratio IS NULL)
-- To:
-- (commented out or removed)

-- Revert model_registry_v3.json to V3.3.0
-- Regenerate lead list
```

---

## Future Enhancements

Based on the analysis, consider these future improvements:

1. **Investigate Custodian Data** - Run diagnostic queries to understand actual field values
2. **Test Moderate Discretionary Exclusion** - Consider excluding 50-80% range (0.39x lift)
3. **Add Discretionary to V4 Model** - Include as continuous feature for ML optimization
4. **Monitor Exclusion Impact** - Track actual conversion rates post-implementation
