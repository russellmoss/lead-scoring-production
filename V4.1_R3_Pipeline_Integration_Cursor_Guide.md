# V4.1-R3 Pipeline Integration Guide for Cursor.ai

**Document Version**: 1.0  
**Created**: 2025-12-30  
**Purpose**: Step-by-step guide for Cursor.ai to integrate V4.1-R3 model into production pipeline  
**Working Directory**: `C:\Users\russe\Documents\lead_scoring_production`  
**Execution Log**: `pipeline/logs/V4.1_INTEGRATION_LOG.md`

---

## Table of Contents

1. [Overview & Context](#step-0-overview--context)
2. [Step 1: Create Execution Log](#step-1-create-execution-log)
3. [Step 2: Create V4.1 Feature Engineering SQL](#step-2-create-v41-feature-engineering-sql)
4. [Step 3: Update Monthly Scoring Script](#step-3-update-monthly-scoring-script)
5. [Step 4: Update Hybrid Lead List SQL](#step-4-update-hybrid-lead-list-sql)
6. [Step 5: Update Root README.md](#step-5-update-root-readmemd)
7. [Step 6: Create Validation Queries](#step-6-create-validation-queries)
8. [Step 7: Final Verification Checklist](#step-7-final-verification-checklist)

---

## Step 0: Overview & Context

### Why We're Making These Changes

**V4.1-R3 Model Improvements:**
- **Test AUC-ROC**: 0.620 (+3.5% vs V4.0.0's 0.599)
- **Top Decile Lift**: 2.03x (+34% vs V4.0.0's 1.51x)
- **Features**: 22 (vs V4.0.0's 14) - adds bleeding signals and firm/rep type
- **SHAP Interpretability**: Full KernelExplainer support (vs limited in V4.0.0)
- **Overfitting**: Controlled (AUC gap 0.075, well below 0.15 threshold)

**New Features in V4.1:**
1. `is_recent_mover` - Moved firms in last 12 months
2. `days_since_last_move` - Days since joining current firm
3. `firm_departures_corrected` - Corrected firm departure count
4. `bleeding_velocity_encoded` - Firm bleeding acceleration (0-3 scale)
5. `is_independent_ria` - Independent RIA flag
6. `is_ia_rep_type` - IA rep type flag
7. `is_dual_registered` - Dual registered (broker-dealer ties)

**Removed Features (Multicollinearity):**
- `industry_tenure_months` (r=0.96 with `experience_years`)
- `tenure_bucket_x_mobility` (r=0.94 with `mobility_3yr`)
- `independent_ria_x_ia_rep` (r=0.97 with `is_ia_rep_type`)
- `recent_mover_x_bleeding` (r=0.90 with `is_recent_mover`)

### Files to Create/Update

| File | Action | Purpose |
|------|--------|---------|
| `pipeline/logs/V4.1_INTEGRATION_LOG.md` | CREATE | Track integration progress |
| `pipeline/sql/v4_1_prospect_features.sql` | CREATE | V4.1 feature engineering (22 features) |
| `pipeline/scripts/score_prospects_monthly.py` | UPDATE | Point to V4.1.0 model |
| `pipeline/sql/February_2026_Lead_List_V3_V4_1_Hybrid.sql` | CREATE | Updated hybrid query |
| `README.md` | UPDATE | Document V4.1 improvements |
| `pipeline/sql/v4_1_validation_queries.sql` | CREATE | Validation SQL |

---

## Step 1: Create Execution Log

### Cursor Prompt 1.1

```
@workspace Create the V4.1 integration execution log file.

WORKING DIRECTORY: C:\Users\russe\Documents\lead_scoring_production

Task:
1. Create file: pipeline/logs/V4.1_INTEGRATION_LOG.md
2. Initialize with header and status tracking sections
3. This file will be updated after each step to track progress

Execute now.
```

### Code: pipeline/logs/V4.1_INTEGRATION_LOG.md

```markdown
# V4.1-R3 Pipeline Integration Execution Log

**Started**: [TIMESTAMP]
**Status**: ðŸŸ¡ In Progress
**Operator**: Cursor.ai

---

## Integration Overview

| Step | Description | Status | Completed |
|------|-------------|--------|-----------|
| 1 | Create Execution Log | â³ | - |
| 2 | Create V4.1 Feature Engineering SQL | â³ | - |
| 3 | Update Monthly Scoring Script | â³ | - |
| 4 | Update Hybrid Lead List SQL | â³ | - |
| 5 | Update Root README.md | â³ | - |
| 6 | Create Validation Queries | â³ | - |
| 7 | Final Verification | â³ | - |

---

## Step 1: Create Execution Log

**Started**: [TIMESTAMP]
**Status**: âœ… COMPLETE

- Created this file: `pipeline/logs/V4.1_INTEGRATION_LOG.md`

---

## Step 2: Create V4.1 Feature Engineering SQL

**Started**: [TIMESTAMP]
**Status**: â³ Pending

### Actions
- [ ] Created `pipeline/sql/v4_1_prospect_features.sql`
- [ ] Verified 22 features included
- [ ] Verified 4 removed features NOT included
- [ ] Verified new V4.1 features present

### Verification Results
```
Total features: [PENDING]
New V4.1 features: [PENDING]
Removed features found: [PENDING]
```

---

## Step 3: Update Monthly Scoring Script

**Started**: [TIMESTAMP]
**Status**: â³ Pending

### Actions
- [ ] Updated V4_MODEL_DIR path
- [ ] Updated V4_FEATURES_FILE path
- [ ] Updated FEATURES_TABLE reference
- [ ] Updated feature list to 22 features

### Verification Results
```
Model path: [PENDING]
Features file path: [PENDING]
Feature count: [PENDING]
```

---

## Step 4: Update Hybrid Lead List SQL

**Started**: [TIMESTAMP]
**Status**: â³ Pending

### Actions
- [ ] Created `pipeline/sql/February_2026_Lead_List_V3_V4_1_Hybrid.sql`
- [ ] Updated V4 scores table reference
- [ ] Added new V4.1 columns to output
- [ ] Updated disagreement threshold (70th â†’ 60th percentile option)

### Verification Results
```
V4 scores table: [PENDING]
New columns added: [PENDING]
Disagreement threshold: [PENDING]
```

---

## Step 5: Update Root README.md

**Started**: [TIMESTAMP]
**Status**: â³ Pending

### Actions
- [ ] Added V4.1 model section
- [ ] Documented performance improvements
- [ ] Added validation results
- [ ] Updated pipeline architecture diagram

---

## Step 6: Create Validation Queries

**Started**: [TIMESTAMP]
**Status**: â³ Pending

### Actions
- [ ] Created `pipeline/sql/v4_1_validation_queries.sql`
- [ ] Feature distribution queries
- [ ] Score comparison queries
- [ ] Hybrid filter queries

---

## Step 7: Final Verification

**Started**: [TIMESTAMP]
**Status**: â³ Pending

### Checklist
- [ ] All files created successfully
- [ ] No syntax errors in SQL
- [ ] Model paths verified
- [ ] Feature count = 22
- [ ] README updated with all sections

---

## Errors & Issues

*None recorded yet*

---

## Rollback Instructions

If integration fails:
1. Revert to V4.0.0 model paths in `score_prospects_monthly.py`
2. Use existing `January_2026_Lead_List_V3_V4_Hybrid.sql`
3. Document failure reason in this log

---

**Last Updated**: [TIMESTAMP]
```

### Verification 1.1

```
Verify file exists: pipeline/logs/V4.1_INTEGRATION_LOG.md
Expected: File created with all sections
```

---

## Step 2: Create V4.1 Feature Engineering SQL

### Cursor Prompt 2.1

```
@workspace Create the V4.1 feature engineering SQL with all 22 features.

WORKING DIRECTORY: C:\Users\russe\Documents\lead_scoring_production

Context:
- V4.1.0 uses 22 features (V4.0.0 used 14)
- 8 new features added for bleeding signals and firm/rep type
- 4 features removed due to multicollinearity
- Must join to: inferred_departures_analysis, firm_bleeding_velocity tables
- Output table: ml_features.v4_1_prospect_features

Task:
1. Create file: pipeline/sql/v4_1_prospect_features.sql
2. Include all 22 V4.1 features
3. Add proper JOINs to new tables
4. Include header documentation
5. Update execution log with results

Reference existing file: pipeline/sql/v4_prospect_features.sql (V4.0.0 version)

Execute now.
```

### Code: pipeline/sql/v4_1_prospect_features.sql

```sql
-- ============================================================================
-- V4.1 PROSPECT FEATURE ENGINEERING
-- ============================================================================
-- 
-- VERSION: V4.1.0 R3
-- CREATED: 2025-12-30
-- PURPOSE: Calculate all 22 V4.1 features for prospect scoring
-- 
-- CHANGES FROM V4.0.0:
-- - ADDED 8 new features (bleeding signals, firm/rep type)
-- - REMOVED 4 features (multicollinearity: r > 0.90)
-- - Total features: 22 (was 14)
-- 
-- NEW FEATURES:
-- - is_recent_mover (moved in last 12 months)
-- - days_since_last_move (days since joining current firm)
-- - firm_departures_corrected (corrected departure count from inferred_departures_analysis)
-- - bleeding_velocity_encoded (0=STABLE, 1=DECELERATING, 2=STEADY, 3=ACCELERATING)
-- - is_independent_ria (SEC registered, state notice filed)
-- - is_ia_rep_type (IA rep type)
-- - is_dual_registered (both broker-dealer and IA)
-- 
-- REMOVED FEATURES (multicollinearity):
-- - industry_tenure_months (r=0.96 with experience_years)
-- - tenure_bucket_x_mobility (r=0.94 with mobility_3yr)
-- - independent_ria_x_ia_rep (r=0.97 with is_ia_rep_type)
-- - recent_mover_x_bleeding (r=0.90 with is_recent_mover)
-- 
-- OUTPUT: ml_features.v4_1_prospect_features
-- 
-- USAGE:
--   Run this SQL before monthly lead list generation
--   Then run score_prospects_monthly.py to generate scores
-- 
-- ============================================================================

CREATE OR REPLACE TABLE `savvy-gtm-analytics.ml_features.v4_1_prospect_features` AS

WITH 
-- ============================================================================
-- A. BASE PROSPECTS (All advisors in FINTRX)
-- ============================================================================
base_prospects AS (
    SELECT 
        c.RIA_CONTACT_CRD_ID as crd,
        SAFE_CAST(c.FIRM_CRD AS INT64) as firm_crd,
        c.FIRST_NAME as first_name,
        c.LAST_NAME as last_name,
        c.EMAIL as email,
        c.PHONE as phone,
        c.LINKEDIN_PROFILE_URL as linkedin_url,
        c.PRIMARY_FIRM_START_DATE as firm_start_date,
        c.REP_TYPE as rep_type,
        c.REP_LICENSES as rep_licenses,
        c.INDUSTRY_TENURE_MONTHS as industry_tenure_months,
        CURRENT_DATE() as prediction_date
    FROM `savvy-gtm-analytics.FinTrx_data_CA.ria_contacts_current` c
    WHERE c.RIA_CONTACT_CRD_ID IS NOT NULL
),

-- ============================================================================
-- B. CURRENT FIRM TENURE
-- ============================================================================
current_firm AS (
    SELECT 
        bp.crd,
        bp.firm_crd,
        bp.firm_start_date,
        DATE_DIFF(CURRENT_DATE(), bp.firm_start_date, MONTH) as tenure_months,
        DATE_DIFF(CURRENT_DATE(), bp.firm_start_date, DAY) as tenure_days
    FROM base_prospects bp
    WHERE bp.firm_start_date IS NOT NULL
),

-- ============================================================================
-- C. EMPLOYMENT HISTORY & MOBILITY
-- ============================================================================
employment_history AS (
    SELECT 
        SAFE_CAST(REGEXP_REPLACE(CAST(h.CONTACT_CRD AS STRING), r'[^0-9]', '') AS INT64) as crd,
        COUNT(DISTINCT h.FIRM_CRD) as total_firms,
        COUNT(CASE WHEN h.START_DATE >= DATE_SUB(CURRENT_DATE(), INTERVAL 3 YEAR) THEN 1 END) as moves_3yr,
        MIN(h.START_DATE) as first_job_date
    FROM `savvy-gtm-analytics.FinTrx_data_CA.contact_registered_employment_history` h
    WHERE h.CONTACT_CRD IS NOT NULL
    GROUP BY 1
),

-- ============================================================================
-- D. FIRM METRICS (Current)
-- ============================================================================
firm_metrics AS (
    SELECT 
        f.FIRM_CRD as firm_crd,
        f.FIRM_NAME as firm_name,
        f.REP_COUNT as firm_rep_count,
        f.SEC_REGISTRATION_STATUS as sec_registration_status,
        f.STATE_REGISTRATION_STATUS as state_registration_status
    FROM `savvy-gtm-analytics.FinTrx_data_CA.ria_companies_current` f
),

-- ============================================================================
-- E. FIRM BLEEDING METRICS (Corrected - from inferred_departures_analysis)
-- ============================================================================
firm_bleeding AS (
    SELECT 
        ida.firm_crd,
        ida.departures_12mo_inferred as firm_departures_corrected,
        ida.net_change_12mo_inferred as firm_net_change_12mo,
        -- Stability tier based on corrected net change
        CASE 
            WHEN ida.net_change_12mo_inferred <= -10 THEN 'Heavy_Bleeding'
            WHEN ida.net_change_12mo_inferred <= -5 THEN 'Moderate_Bleeding'
            WHEN ida.net_change_12mo_inferred <= 0 THEN 'Slight_Bleeding'
            WHEN ida.net_change_12mo_inferred <= 5 THEN 'Stable'
            ELSE 'Growing'
        END as firm_stability_tier
    FROM `savvy-gtm-analytics.ml_features.inferred_departures_analysis` ida
),

-- ============================================================================
-- F. FIRM BLEEDING VELOCITY (NEW in V4.1)
-- ============================================================================
bleeding_velocity AS (
    SELECT 
        bv.firm_crd,
        bv.bleeding_velocity,
        -- Encode velocity: 0=STABLE, 1=DECELERATING, 2=STEADY, 3=ACCELERATING
        CASE 
            WHEN bv.bleeding_velocity = 'ACCELERATING' THEN 3
            WHEN bv.bleeding_velocity = 'STEADY' THEN 2
            WHEN bv.bleeding_velocity = 'DECELERATING' THEN 1
            ELSE 0  -- STABLE or NULL
        END as bleeding_velocity_encoded
    FROM `savvy-gtm-analytics.ml_features.firm_bleeding_velocity_v41` bv
),

-- ============================================================================
-- G. WIREHOUSE LIST
-- ============================================================================
wirehouses AS (
    SELECT firm_pattern FROM UNNEST([
        '%Morgan Stanley%', '%Merrill Lynch%', '%Wells Fargo Advisors%',
        '%UBS Financial%', '%Edward Jones%', '%Raymond James%',
        '%Ameriprise%', '%LPL Financial%', '%Northwestern Mutual%',
        '%Stifel%', '%RBC Wealth%', '%Janney Montgomery%'
    ]) as firm_pattern
),

-- ============================================================================
-- H. BROKER PROTOCOL FIRMS
-- ============================================================================
broker_protocol AS (
    SELECT DISTINCT firm_crd
    FROM `savvy-gtm-analytics.ml_features.broker_protocol_firms`
),

-- ============================================================================
-- I. EXPERIENCE CALCULATION
-- ============================================================================
experience_calc AS (
    SELECT 
        bp.crd,
        -- Use industry tenure months, convert to years
        COALESCE(bp.industry_tenure_months, 0) / 12.0 as experience_years
    FROM base_prospects bp
),

-- ============================================================================
-- J. COMBINE ALL FEATURES (22 total for V4.1)
-- ============================================================================
all_features AS (
    SELECT
        -- ================================================================
        -- IDENTIFIERS
        -- ================================================================
        bp.crd,
        bp.firm_crd,
        bp.prediction_date,
        
        -- ================================================================
        -- FEATURE 1: tenure_months
        -- ================================================================
        COALESCE(cf.tenure_months, 0) as tenure_months,
        
        -- ================================================================
        -- FEATURE 2: tenure_bucket_encoded
        -- ================================================================
        CASE
            WHEN cf.tenure_months IS NULL THEN 0  -- Unknown
            WHEN cf.tenure_months < 12 THEN 1     -- 0-12
            WHEN cf.tenure_months < 24 THEN 2     -- 12-24
            WHEN cf.tenure_months < 48 THEN 3     -- 24-48
            WHEN cf.tenure_months < 120 THEN 4    -- 48-120
            ELSE 5                                 -- 120+
        END as tenure_bucket_encoded,
        
        -- ================================================================
        -- FEATURE 3: experience_years
        -- ================================================================
        COALESCE(ec.experience_years, 0) as experience_years,
        
        -- ================================================================
        -- FEATURE 4: mobility_3yr
        -- ================================================================
        COALESCE(eh.moves_3yr, 0) as mobility_3yr,
        
        -- ================================================================
        -- FEATURE 5: mobility_tier_encoded
        -- ================================================================
        CASE
            WHEN COALESCE(eh.moves_3yr, 0) = 0 THEN 0  -- No_Mobility
            WHEN eh.moves_3yr = 1 THEN 1               -- Low_Mobility
            WHEN eh.moves_3yr = 2 THEN 2               -- Moderate_Mobility
            ELSE 3                                      -- High_Mobility
        END as mobility_tier_encoded,
        
        -- ================================================================
        -- FEATURE 6: firm_rep_count_at_contact
        -- ================================================================
        COALESCE(fm.firm_rep_count, 0) as firm_rep_count_at_contact,
        
        -- ================================================================
        -- FEATURE 7: firm_net_change_12mo
        -- ================================================================
        COALESCE(fb.firm_net_change_12mo, 0) as firm_net_change_12mo,
        
        -- ================================================================
        -- FEATURE 8: firm_stability_tier_encoded
        -- ================================================================
        CASE
            WHEN fb.firm_stability_tier = 'Heavy_Bleeding' THEN 4
            WHEN fb.firm_stability_tier = 'Moderate_Bleeding' THEN 3
            WHEN fb.firm_stability_tier = 'Slight_Bleeding' THEN 2
            WHEN fb.firm_stability_tier = 'Stable' THEN 1
            WHEN fb.firm_stability_tier = 'Growing' THEN 0
            ELSE 1  -- Default to Stable
        END as firm_stability_tier_encoded,
        
        -- ================================================================
        -- FEATURE 9: is_wirehouse
        -- ================================================================
        CASE WHEN EXISTS (
            SELECT 1 FROM wirehouses w 
            WHERE UPPER(fm.firm_name) LIKE UPPER(w.firm_pattern)
        ) THEN 1 ELSE 0 END as is_wirehouse,
        
        -- ================================================================
        -- FEATURE 10: is_broker_protocol
        -- ================================================================
        CASE WHEN bpm.firm_crd IS NOT NULL THEN 1 ELSE 0 END as is_broker_protocol,
        
        -- ================================================================
        -- FEATURE 11: has_email
        -- ================================================================
        CASE WHEN bp.email IS NOT NULL AND bp.email != '' THEN 1 ELSE 0 END as has_email,
        
        -- ================================================================
        -- FEATURE 12: has_linkedin
        -- ================================================================
        CASE WHEN bp.linkedin_url IS NOT NULL AND bp.linkedin_url != '' THEN 1 ELSE 0 END as has_linkedin,
        
        -- ================================================================
        -- FEATURE 13: has_firm_data
        -- ================================================================
        CASE WHEN fm.firm_crd IS NOT NULL THEN 1 ELSE 0 END as has_firm_data,
        
        -- ================================================================
        -- FEATURE 14: mobility_x_heavy_bleeding (INTERACTION)
        -- ================================================================
        CASE 
            WHEN COALESCE(eh.moves_3yr, 0) >= 2 
                 AND fb.firm_stability_tier = 'Heavy_Bleeding' 
            THEN 1 ELSE 0 
        END as mobility_x_heavy_bleeding,
        
        -- ================================================================
        -- FEATURE 15: short_tenure_x_high_mobility (INTERACTION)
        -- ================================================================
        CASE 
            WHEN COALESCE(cf.tenure_months, 999) < 24 
                 AND COALESCE(eh.moves_3yr, 0) >= 2 
            THEN 1 ELSE 0 
        END as short_tenure_x_high_mobility,
        
        -- ================================================================
        -- NEW V4.1 FEATURES (16-22)
        -- ================================================================
        
        -- ================================================================
        -- FEATURE 16: is_recent_mover (NEW in V4.1)
        -- Moved firms in last 12 months
        -- ================================================================
        CASE 
            WHEN cf.tenure_months IS NOT NULL AND cf.tenure_months <= 12 
            THEN 1 ELSE 0 
        END as is_recent_mover,
        
        -- ================================================================
        -- FEATURE 17: days_since_last_move (NEW in V4.1)
        -- Days since joining current firm
        -- ================================================================
        COALESCE(cf.tenure_days, 9999) as days_since_last_move,
        
        -- ================================================================
        -- FEATURE 18: firm_departures_corrected (NEW in V4.1)
        -- Corrected firm departure count from inferred_departures_analysis
        -- ================================================================
        COALESCE(fb.firm_departures_corrected, 0) as firm_departures_corrected,
        
        -- ================================================================
        -- FEATURE 19: bleeding_velocity_encoded (NEW in V4.1)
        -- Firm bleeding acceleration: 0=STABLE, 1=DECELERATING, 2=STEADY, 3=ACCELERATING
        -- ================================================================
        COALESCE(bv.bleeding_velocity_encoded, 0) as bleeding_velocity_encoded,
        
        -- ================================================================
        -- FEATURE 20: is_independent_ria (NEW in V4.1)
        -- SEC registered + state notice filed = independent RIA
        -- ================================================================
        CASE 
            WHEN fm.sec_registration_status = 'Registered' 
                 AND fm.state_registration_status IN ('Notice Filed', 'Not Required') 
            THEN 1 ELSE 0 
        END as is_independent_ria,
        
        -- ================================================================
        -- FEATURE 21: is_ia_rep_type (NEW in V4.1)
        -- Investment Advisor rep type
        -- ================================================================
        CASE WHEN bp.rep_type = 'IA' THEN 1 ELSE 0 END as is_ia_rep_type,
        
        -- ================================================================
        -- FEATURE 22: is_dual_registered (NEW in V4.1)
        -- Both broker-dealer and investment advisor
        -- ================================================================
        CASE 
            WHEN bp.rep_type = 'Dual' 
                 OR (bp.rep_licenses LIKE '%Series 7%' AND bp.rep_licenses LIKE '%Series 65%') 
            THEN 1 ELSE 0 
        END as is_dual_registered,
        
        -- ================================================================
        -- METADATA
        -- ================================================================
        CURRENT_TIMESTAMP() as created_at,
        'v4.1.0' as feature_version

    FROM base_prospects bp
    LEFT JOIN current_firm cf ON bp.crd = cf.crd
    LEFT JOIN employment_history eh ON bp.crd = eh.crd
    LEFT JOIN firm_metrics fm ON bp.firm_crd = fm.firm_crd
    LEFT JOIN firm_bleeding fb ON bp.firm_crd = fb.firm_crd
    LEFT JOIN bleeding_velocity bv ON bp.firm_crd = bv.firm_crd
    LEFT JOIN broker_protocol bpm ON bp.firm_crd = bpm.firm_crd
    LEFT JOIN experience_calc ec ON bp.crd = ec.crd
)

-- ============================================================================
-- FINAL OUTPUT
-- ============================================================================
SELECT * FROM all_features;

-- ============================================================================
-- VALIDATION QUERY (Run after table creation)
-- ============================================================================
/*
SELECT 
    'Total Prospects' as metric,
    COUNT(*) as value
FROM `savvy-gtm-analytics.ml_features.v4_1_prospect_features`
UNION ALL
SELECT 'Feature Version' as metric, MAX(feature_version) as value
FROM `savvy-gtm-analytics.ml_features.v4_1_prospect_features`
UNION ALL
SELECT 'Avg tenure_months' as metric, CAST(ROUND(AVG(tenure_months), 2) AS STRING)
FROM `savvy-gtm-analytics.ml_features.v4_1_prospect_features`
UNION ALL
SELECT 'Recent Movers (is_recent_mover=1)' as metric, CAST(SUM(is_recent_mover) AS STRING)
FROM `savvy-gtm-analytics.ml_features.v4_1_prospect_features`
UNION ALL
SELECT 'Dual Registered (is_dual_registered=1)' as metric, CAST(SUM(is_dual_registered) AS STRING)
FROM `savvy-gtm-analytics.ml_features.v4_1_prospect_features`
UNION ALL
SELECT 'Independent RIA (is_independent_ria=1)' as metric, CAST(SUM(is_independent_ria) AS STRING)
FROM `savvy-gtm-analytics.ml_features.v4_1_prospect_features`;
*/
```

### Verification 2.1

```
@workspace Verify the V4.1 feature engineering SQL is correct.

Check:
1. File exists: pipeline/sql/v4_1_prospect_features.sql
2. Contains exactly 22 features (count FEATURE comments)
3. Contains NO removed features:
   - industry_tenure_months (as a feature, not source)
   - tenure_bucket_x_mobility
   - independent_ria_x_ia_rep
   - recent_mover_x_bleeding
4. Contains ALL new V4.1 features:
   - is_recent_mover
   - days_since_last_move
   - firm_departures_corrected
   - bleeding_velocity_encoded
   - is_independent_ria
   - is_ia_rep_type
   - is_dual_registered

Update pipeline/logs/V4.1_INTEGRATION_LOG.md with results.
```

---

## Step 3: Update Monthly Scoring Script

### Cursor Prompt 3.1

```
@workspace Update the monthly scoring script to use V4.1.0 model and features.

WORKING DIRECTORY: C:\Users\russe\Documents\lead_scoring_production

File to update: pipeline/scripts/score_prospects_monthly.py

Changes required:
1. Update V4_MODEL_DIR to: v4/models/v4.1.0
2. Update V4_FEATURES_FILE to: v4/data/v4.1.0/final_features.json
3. Update FEATURES_TABLE to: v4_1_prospect_features
4. Update SCORES_TABLE to: v4_1_prospect_scores
5. Add comment header noting V4.1.0 update

Also verify:
- v4/models/v4.1.0/model.pkl exists
- v4/data/v4.1.0/final_features.json exists

Update execution log with results.

Execute now.
```

### Code Changes: pipeline/scripts/score_prospects_monthly.py

Find and replace these sections:

```python
# ============================================================================
# BEFORE (V4.0.0):
# ============================================================================
# V4_MODEL_DIR = Path(r"C:\Users\russe\Documents\lead_scoring_production\v4\models\v4.0.0")
# V4_FEATURES_FILE = Path(r"C:\Users\russe\Documents\lead_scoring_production\v4\data\processed\final_features.json")
# FEATURES_TABLE = "v4_prospect_features"
# SCORES_TABLE = "v4_prospect_scores"

# ============================================================================
# AFTER (V4.1.0):
# ============================================================================
# Updated for V4.1.0 R3 deployment (2025-12-30)
# - Model: 22 features (was 14)
# - Performance: 0.620 AUC (+3.5%), 2.03x lift (+34%)
# - New features: bleeding signals, firm/rep type
V4_MODEL_DIR = Path(r"C:\Users\russe\Documents\lead_scoring_production\v4\models\v4.1.0")
V4_FEATURES_FILE = Path(r"C:\Users\russe\Documents\lead_scoring_production\v4\data\v4.1.0\final_features.json")
FEATURES_TABLE = "v4_1_prospect_features"
SCORES_TABLE = "v4_1_prospect_scores"
```

Also update the script header:

```python
"""
Score all prospects with V4.1.0 model and generate SHAP-based narratives.
Run monthly BEFORE lead list generation.

VERSION: V4.1.0 R3
UPDATED: 2025-12-30

CHANGES FROM V4.0.0:
- Model upgraded to V4.1.0 R3 (0.620 AUC, 2.03x lift)
- Features increased from 14 to 22
- Added bleeding signal features
- Added firm/rep type features
- Improved SHAP interpretability

Working Directory: pipeline
Usage: python scripts/score_prospects_monthly.py
"""
```

### Verification 3.1

```
@workspace Verify the scoring script updates are correct.

Check in pipeline/scripts/score_prospects_monthly.py:
1. V4_MODEL_DIR contains "v4.1.0" (not "v4.0.0")
2. V4_FEATURES_FILE contains "v4.1.0" (not "processed")
3. FEATURES_TABLE = "v4_1_prospect_features"
4. SCORES_TABLE = "v4_1_prospect_scores"
5. Header updated with V4.1.0 version info

Also verify files exist:
- v4/models/v4.1.0/model.pkl
- v4/data/v4.1.0/final_features.json

Update pipeline/logs/V4.1_INTEGRATION_LOG.md with results.
```

---

## Step 4: Update Hybrid Lead List SQL

### Cursor Prompt 4.1

```
@workspace Create the February 2026 lead list SQL with V4.1 integration.

WORKING DIRECTORY: C:\Users\russe\Documents\lead_scoring_production

Base file: pipeline/sql/January_2026_Lead_List_V3_V4_Hybrid.sql
New file: pipeline/sql/February_2026_Lead_List_V3_V4_1_Hybrid.sql

Changes required:
1. Update V4 scores table from v4_prospect_scores to v4_1_prospect_scores
2. Add new V4.1 columns to output:
   - is_recent_mover
   - days_since_last_move
   - firm_departures_corrected
   - bleeding_velocity_encoded
   - is_dual_registered
3. Update header to reflect V4.1 integration
4. Consider updating disagreement threshold from 70th to 60th percentile
   (V4.1 is more accurate, can be more aggressive)
5. Update output table name to include V4.1 reference

Key changes in v4_enriched CTE:
- Join to v4_1_prospect_scores instead of v4_prospect_scores
- Select additional V4.1 feature columns

Update execution log with results.

Execute now.
```

### Code: pipeline/sql/February_2026_Lead_List_V3_V4_1_Hybrid.sql

Create this new file based on January_2026 with these modifications:

```sql
-- ============================================================================
-- FEBRUARY 2026 LEAD LIST GENERATOR (V3.2.5 + V4.1.0 R3 HYBRID)
-- ============================================================================
-- 
-- VERSION: V3.2.5 + V4.1.0 R3 Hybrid
-- CREATED: 2025-12-30
-- 
-- V4.1 INTEGRATION CHANGES:
-- - Scores table: ml_features.v4_1_prospect_scores (was v4_prospect_scores)
-- - Features: 22 (was 14)
-- - New columns: is_recent_mover, days_since_last_move, firm_departures_corrected,
--                bleeding_velocity_encoded, is_dual_registered
-- - Disagreement threshold: 60th percentile (was 70th) - V4.1 is more accurate
-- 
-- V4.1 PERFORMANCE IMPROVEMENTS:
-- - Test AUC-ROC: 0.620 (+3.5% vs V4.0.0)
-- - Top Decile Lift: 2.03x (+34% vs V4.0.0)
-- - Better bleeding signal detection
-- 
-- HYBRID ARCHITECTURE:
-- - V3 Rules: Primary tier classification (T1A, T1B, T1, T1F, T2, T3)
-- - V4.1 ML: Deprioritization (bottom 20%) + disagreement filtering + backfill
-- 
-- OUTPUT: ml_features.february_2026_lead_list_v41
-- 
-- ============================================================================

-- [Keep all existing CTEs through enriched_prospects unchanged]

-- ============================================================================
-- J2. JOIN V4.1 SCORES (UPDATED FOR V4.1)
-- ============================================================================
v4_enriched AS (
    SELECT 
        ep.*,
        -- V4.1 Score and percentile
        COALESCE(v4.v4_score, 0.5) as v4_score,
        COALESCE(v4.v4_percentile, 50) as v4_percentile,
        COALESCE(v4.v4_deprioritize, FALSE) as v4_deprioritize,
        
        -- NEW V4.1 Feature columns (for enhanced narratives)
        COALESCE(v4.is_recent_mover, 0) as v4_is_recent_mover,
        COALESCE(v4.days_since_last_move, 9999) as v4_days_since_last_move,
        COALESCE(v4.firm_departures_corrected, 0) as v4_firm_departures_corrected,
        COALESCE(v4.bleeding_velocity_encoded, 0) as v4_bleeding_velocity_encoded,
        COALESCE(v4.is_dual_registered, 0) as v4_is_dual_registered,
        
        -- V4.1 SHAP narratives (if available)
        v4.shap_top1_feature,
        v4.shap_top1_value,
        v4.shap_top2_feature,
        v4.shap_top2_value,
        v4.shap_top3_feature,
        v4.shap_top3_value,
        v4.v4_narrative
        
    FROM enriched_prospects ep
    LEFT JOIN `savvy-gtm-analytics.ml_features.v4_1_prospect_scores` v4 
        ON ep.crd = v4.crd
),

-- [Continue with scored_prospects CTE, using v4_enriched]

-- ============================================================================
-- R. FINAL LEAD LIST (V4.1 DISAGREEMENT FILTER - Updated threshold)
-- ============================================================================
-- V4.1 has better lift (2.03x vs 1.51x), so we can be more aggressive
-- Updated threshold from 70th to 60th percentile for disagreement filtering
-- 
-- Logic: Tier 1 leads with V4.1 < 60th percentile are likely false positives
-- V4.1 now has bleeding signal built-in, so it better understands V3 rules
-- ============================================================================
final_lead_list AS (
    SELECT 
        lws.*,
        -- Enhanced V4.1 narrative combining V3 rules + V4.1 SHAP
        CASE 
            WHEN lws.v4_narrative IS NOT NULL THEN
                CONCAT(lws.v3_score_narrative, ' | V4.1 Signal: ', lws.v4_narrative)
            ELSE
                lws.v3_score_narrative
        END as combined_narrative
    FROM leads_with_sga lws
    WHERE NOT (
        -- V3/V4.1 Disagreement Filter
        -- Exclude Tier 1 leads where V4.1 < 60th percentile (was 70th for V4.0)
        lws.score_tier IN (
            'TIER_1A_PRIME_MOVER_CFP', 
            'TIER_1B_PRIME_MOVER_SERIES65',
            'TIER_1_PRIME_MOVER',
            'TIER_1F_HV_WEALTH_BLEEDER'
        )
        AND lws.v4_percentile < 60  -- CHANGED from 70 (V4.1 is more accurate)
    )
)

-- ============================================================================
-- FINAL OUTPUT
-- ============================================================================
SELECT 
    -- Core identifiers
    crd as advisor_crd,
    existing_lead_id as salesforce_lead_id,
    first_name,
    last_name,
    email,
    phone,
    linkedin_url,
    
    -- Firm info
    firm_name,
    firm_crd,
    firm_rep_count,
    firm_net_change_12mo,
    
    -- Advisor profile
    tenure_months,
    ROUND(tenure_months / 12.0, 1) as tenure_years,
    experience_years as industry_tenure_years,
    num_prior_firms,
    moves_3yr,
    
    -- V3 Scoring
    score_tier,
    priority_rank,
    expected_conversion_rate,
    ROUND(expected_conversion_rate * 100, 2) as expected_rate_pct,
    v3_score_narrative,
    
    -- V4.1 Scoring (UPDATED)
    ROUND(v4_score, 4) as v4_score,
    v4_percentile,
    v4_narrative,
    combined_narrative as score_narrative,
    
    -- V4.1 Feature Values (NEW - for transparency)
    v4_is_recent_mover,
    v4_days_since_last_move,
    v4_firm_departures_corrected,
    v4_bleeding_velocity_encoded,
    v4_is_dual_registered,
    
    -- V4.1 SHAP Features (for SDR context)
    shap_top1_feature,
    shap_top2_feature,
    shap_top3_feature,
    
    -- Assignment
    prospect_type,
    sga_owner,
    has_linkedin,
    job_title,
    
    -- Ranking
    overall_rank as list_rank,
    'v3.2.5_v4.1.0_r3' as model_version,
    CURRENT_TIMESTAMP() as generated_at

FROM final_lead_list
ORDER BY list_rank;
```

### Verification 4.1

```
@workspace Verify the February 2026 hybrid SQL is correct.

Check in pipeline/sql/February_2026_Lead_List_V3_V4_1_Hybrid.sql:
1. v4_enriched CTE joins to v4_1_prospect_scores (not v4_prospect_scores)
2. New V4.1 columns selected:
   - v4_is_recent_mover
   - v4_days_since_last_move
   - v4_firm_departures_corrected
   - v4_bleeding_velocity_encoded
   - v4_is_dual_registered
3. Disagreement threshold changed to 60 (was 70)
4. model_version shows 'v3.2.5_v4.1.0_r3'
5. Header updated with V4.1 information

Update pipeline/logs/V4.1_INTEGRATION_LOG.md with results.
```

---

## Step 5: Update Root README.md

### Cursor Prompt 5.1

```
@workspace Update the root README.md with V4.1 model information.

WORKING DIRECTORY: C:\Users\russe\Documents\lead_scoring_production

File to update: README.md

Add a new section documenting:
1. V4.1.0 R3 model improvements
2. Performance comparison (V4.1 vs V4.0 vs V3.2)
3. New features added
4. Validation results
5. Updated pipeline architecture diagram
6. Quick reference for model paths

Insert after the existing V4 section or update the V4 section entirely.

Update execution log with results.

Execute now.
```

### Code to Add/Update in README.md

Add this section to the README.md (insert after existing model documentation):

```markdown
---

## V4.1.0 R3 Model - Production (Deployed 2025-12-30)

### Executive Summary

V4.1.0 R3 represents a significant upgrade to our lead scoring ML model, achieving:

| Metric | V4.0.0 (Previous) | V4.1.0 R3 (Current) | Improvement |
|--------|-------------------|---------------------|-------------|
| **Test AUC-ROC** | 0.599 | **0.620** | **+3.5%** |
| **Top Decile Lift** | 1.51x | **2.03x** | **+34.4%** |
| **Test AUC-PR** | 0.043 | **0.070** | **+62.8%** |
| **Features** | 14 | **22** | +8 new features |
| **SHAP** | Limited | **Full KernelExplainer** | âœ… Enhanced |

### Why V4.1.0 R3?

**Problem with V4.0.0**: The model lacked direct bleeding signal features. It could only infer firm instability indirectly through `firm_net_change_12mo`, missing important signals like:
- How recently an advisor moved
- The velocity of firm departures (accelerating vs. decelerating)
- Whether advisors are dual-registered (more mobile)

**V4.1.0 Solution**: Added 8 new features capturing:
1. **Bleeding signals**: `is_recent_mover`, `days_since_last_move`, `firm_departures_corrected`, `bleeding_velocity_encoded`
2. **Firm/rep type**: `is_independent_ria`, `is_ia_rep_type`, `is_dual_registered`

### Feature List (22 Features)

#### Original Features (15 retained from V4.0.0)
| # | Feature | Description |
|---|---------|-------------|
| 1 | `tenure_months` | Months at current firm |
| 2 | `tenure_bucket_encoded` | Tenure category (0-5 scale) |
| 3 | `experience_years` | Total industry experience |
| 4 | `mobility_3yr` | Firm moves in last 3 years |
| 5 | `mobility_tier_encoded` | Mobility category (0-3 scale) |
| 6 | `firm_rep_count_at_contact` | Firm headcount |
| 7 | `firm_net_change_12mo` | Firm's net advisor change |
| 8 | `firm_stability_tier_encoded` | Firm bleeding category |
| 9 | `is_wirehouse` | Major wirehouse flag |
| 10 | `is_broker_protocol` | Broker Protocol participant |
| 11 | `has_email` | Email available |
| 12 | `has_linkedin` | LinkedIn available |
| 13 | `has_firm_data` | Firm data quality |
| 14 | `mobility_x_heavy_bleeding` | Interaction: mobile + bleeding firm |
| 15 | `short_tenure_x_high_mobility` | Interaction: short tenure + mobile |

#### New V4.1 Features (7 added)
| # | Feature | Description | Signal |
|---|---------|-------------|--------|
| 16 | `is_recent_mover` | Moved in last 12 months | High mobility indicator |
| 17 | `days_since_last_move` | Days since firm change | Recency signal |
| 18 | `firm_departures_corrected` | Corrected departure count | Firm instability |
| 19 | `bleeding_velocity_encoded` | 0=Stable, 3=Accelerating | Trend direction |
| 20 | `is_independent_ria` | Independent RIA flag | Firm type signal |
| 21 | `is_ia_rep_type` | IA rep type | Rep mobility pattern |
| 22 | `is_dual_registered` | Broker-dealer + IA | Higher mobility potential |

#### Removed Features (4 - multicollinearity)
| Feature | Removed Because | Correlation |
|---------|-----------------|-------------|
| `industry_tenure_months` | Redundant with `experience_years` | r = 0.96 |
| `tenure_bucket_x_mobility` | Redundant with `mobility_3yr` | r = 0.94 |
| `independent_ria_x_ia_rep` | Redundant with `is_ia_rep_type` | r = 0.97 |
| `recent_mover_x_bleeding` | Redundant with `is_recent_mover` | r = 0.90 |

### Validation Results

#### Test Set Performance
```
Test Set: 3,393 leads | 133 conversions | 3.92% conversion rate

Lift by Decile:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Decile  â”‚ Avg Score  â”‚ Conversions â”‚ Conv Rate â”‚   Lift   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0 (bot) â”‚ 0.3306     â”‚ 4           â”‚ 0.99%     â”‚ 0.25x    â”‚
â”‚ 1       â”‚ 0.3791     â”‚ 5           â”‚ 1.82%     â”‚ 0.46x    â”‚
â”‚ 2       â”‚ 0.4015     â”‚ 11          â”‚ 3.24%     â”‚ 0.83x    â”‚
â”‚ 3       â”‚ 0.4443     â”‚ 13          â”‚ 3.83%     â”‚ 0.98x    â”‚
â”‚ 4       â”‚ 0.4720     â”‚ 21          â”‚ 6.18%     â”‚ 1.58x    â”‚
â”‚ 5       â”‚ 0.4968     â”‚ 10          â”‚ 2.95%     â”‚ 0.75x    â”‚
â”‚ 6       â”‚ 0.5196     â”‚ 12          â”‚ 3.54%     â”‚ 0.90x    â”‚
â”‚ 7       â”‚ 0.5390     â”‚ 9           â”‚ 2.65%     â”‚ 0.68x    â”‚
â”‚ 8       â”‚ 0.5662     â”‚ 21          â”‚ 6.19%     â”‚ 1.58x    â”‚
â”‚ 9 (top) â”‚ 0.6193     â”‚ 27          â”‚ 7.94%     â”‚ 2.03x â­ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Validation Gates (All Passed)
| Gate | Criterion | Result | Status |
|------|-----------|--------|--------|
| G9.1 | Test AUC-ROC â‰¥ 0.58 | 0.620 | âœ… PASSED |
| G9.2 | Top Decile Lift â‰¥ 1.4x | 2.03x | âœ… PASSED |
| G9.3 | V4.1 AUC â‰¥ V4.0 AUC | 0.620 > 0.599 | âœ… PASSED |
| G9.4 | Bottom 20% Rate < 2% | 1.40% | âœ… PASSED |
| G8.1 | Overfitting (AUC gap < 0.15) | 0.075 | âœ… PASSED |

### Hybrid Pipeline Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LEAD SCORING HYBRID PIPELINE (V3.2.5 + V4.1.0)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ STEP 1: V3 RULES-BASED TIER CLASSIFICATION                          â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚  T1A_PRIME_MOVER_CFP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 8.7% expected conversion          â”‚    â”‚
â”‚  â”‚  T1B_PRIME_MOVER_SERIES65 â”€â”€â”€â”€â”€â”€â”€ 7.9% expected conversion          â”‚    â”‚
â”‚  â”‚  T1_PRIME_MOVER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 7.1% expected conversion          â”‚    â”‚
â”‚  â”‚  T1F_HV_WEALTH_BLEEDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 6.5% expected conversion          â”‚    â”‚
â”‚  â”‚  T2_PROVEN_MOVER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 5.2% expected conversion          â”‚    â”‚
â”‚  â”‚  T3_MODERATE_BLEEDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4.4% expected conversion          â”‚    â”‚
â”‚  â”‚  STANDARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2.7% baseline                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                      â”‚                                       â”‚
â”‚                                      â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ STEP 2: V4.1 ML MODEL (XGBoost, 22 features)                        â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚  Role 1: DEPRIORITIZE                                                â”‚    â”‚
â”‚  â”‚  â””â”€â”€ Filter bottom 20% by V4.1 score                                â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚  Role 2: DISAGREEMENT FILTER (V3/V4.1 validation)                   â”‚    â”‚
â”‚  â”‚  â””â”€â”€ Exclude T1 leads where V4.1 < 60th percentile                  â”‚    â”‚
â”‚  â”‚  â””â”€â”€ (Was 70th for V4.0.0 - V4.1 is more accurate)                  â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚  Role 3: BACKFILL                                                    â”‚    â”‚
â”‚  â”‚  â””â”€â”€ Identify STANDARD_HIGH_V4 (top 20% of STANDARDs)               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                      â”‚                                       â”‚
â”‚                                      â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ STEP 3: FINAL LEAD LIST                                             â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚  â€¢ ~2,800 leads per month (200 per SGA)                             â”‚    â”‚
â”‚  â”‚  â€¢ Expected conversion: 4.61% (vs 2.74% baseline = +68%)            â”‚    â”‚
â”‚  â”‚  â€¢ Firm diversity cap: 50 leads per firm                            â”‚    â”‚
â”‚  â”‚  â€¢ LinkedIn prioritization                                          â”‚    â”‚
â”‚  â”‚  â€¢ Combined V3 narrative + V4.1 SHAP narrative                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### File Reference

#### Model Files
| File | Path | Description |
|------|------|-------------|
| Model (pickle) | `v4/models/v4.1.0/model.pkl` | Trained XGBoost model |
| Model (JSON) | `v4/models/v4.1.0/model.json` | Model JSON format |
| Features | `v4/data/v4.1.0/final_features.json` | 22 feature list |
| Hyperparameters | `v4/models/v4.1.0/hyperparameters.json` | Training config |
| Feature importance | `v4/models/v4.1.0/feature_importance.csv` | SHAP + XGBoost importance |

#### Pipeline Files
| File | Path | Description |
|------|------|-------------|
| Feature SQL | `pipeline/sql/v4_1_prospect_features.sql` | V4.1 feature engineering |
| Scoring script | `pipeline/scripts/score_prospects_monthly.py` | Monthly scoring (updated) |
| Lead list SQL | `pipeline/sql/February_2026_Lead_List_V3_V4_1_Hybrid.sql` | Hybrid query |
| Validation | `pipeline/sql/v4_1_validation_queries.sql` | Validation queries |

#### Documentation
| File | Path | Description |
|------|------|-------------|
| Final summary | `v4/reports/v4.1/V4.1_Final_Summary.md` | Complete analysis |
| Validation report | `v4/reports/v4.1/model_validation_report_r3.md` | Test results |
| Deployment checklist | `v4/DEPLOYMENT_CHECKLIST_V4.1.md` | Deployment steps |
| Execution log | `v4/EXECUTION_LOG_V4.1.md` | Training log |

### Monthly Execution Checklist (V4.1)

```markdown
## [MONTH] 2026 Lead List Generation (V4.1)

**Date**: YYYY-MM-DD

### Step 1: Generate V4.1 Features
- [ ] Run: pipeline/sql/v4_1_prospect_features.sql
- [ ] Verify: ml_features.v4_1_prospect_features created
- [ ] Row count: __________

### Step 2: Score Prospects
- [ ] Run: python pipeline/scripts/score_prospects_monthly.py
- [ ] Verify: ml_features.v4_1_prospect_scores created
- [ ] Row count: __________
- [ ] Bottom 20% count: __________

### Step 3: Generate Lead List
- [ ] Run: pipeline/sql/[Month]_2026_Lead_List_V3_V4_1_Hybrid.sql
- [ ] Verify: ml_features.[month]_2026_lead_list_v41 created
- [ ] Lead count: __________
- [ ] Tier distribution validated

### Step 4: Export
- [ ] Export to CSV
- [ ] Upload to Salesforce
- [ ] Notify team
```

### Changelog

| Version | Date | Changes |
|---------|------|---------|
| V4.1.0 R3 | 2025-12-30 | Production deployment - 22 features, 0.620 AUC, 2.03x lift |
| V4.1.0 R2 | 2025-12-30 | Added regularization - overfitting controlled |
| V4.1.0 R1 | 2025-12-30 | Initial V4.1 training - 26 features |
| V4.0.0 | 2025-12-15 | Original ML model - 14 features, 0.599 AUC |
| V3.2.5 | 2025-12-01 | Rules-based tier system - production |

---
```

### Verification 5.1

```
@workspace Verify the README.md update is complete.

Check in README.md:
1. V4.1.0 R3 section exists
2. Performance comparison table present
3. Feature list (22 features) documented
4. Validation results included
5. Pipeline architecture diagram present
6. File reference table complete
7. Monthly checklist updated for V4.1

Update pipeline/logs/V4.1_INTEGRATION_LOG.md with results.
```

---

## Step 6: Create Validation Queries

### Cursor Prompt 6.1

```
@workspace Create V4.1 validation queries SQL file.

WORKING DIRECTORY: C:\Users\russe\Documents\lead_scoring_production

Create file: pipeline/sql/v4_1_validation_queries.sql

Include queries to:
1. Validate feature table (v4_1_prospect_features)
2. Validate scores table (v4_1_prospect_scores)
3. Compare V4.0 vs V4.1 score distributions
4. Check V3/V4.1 disagreement filter impact
5. Validate lead list composition

Update execution log with results.

Execute now.
```

### Code: pipeline/sql/v4_1_validation_queries.sql

```sql
-- ============================================================================
-- V4.1 VALIDATION QUERIES
-- ============================================================================
-- 
-- PURPOSE: Validate V4.1 pipeline integration
-- RUN: After each pipeline step to verify correctness
-- 
-- ============================================================================

-- ============================================================================
-- 1. FEATURE TABLE VALIDATION
-- ============================================================================

-- 1.1 Basic counts and feature version
SELECT 
    'v4_1_prospect_features' as table_name,
    COUNT(*) as total_rows,
    COUNT(DISTINCT crd) as unique_advisors,
    MAX(feature_version) as feature_version,
    MIN(created_at) as earliest_created,
    MAX(created_at) as latest_created
FROM `savvy-gtm-analytics.ml_features.v4_1_prospect_features`;

-- 1.2 Feature coverage (check for NULLs)
SELECT 
    'tenure_months' as feature, 
    COUNT(*) as total,
    SUM(CASE WHEN tenure_months IS NULL THEN 1 ELSE 0 END) as nulls,
    ROUND(AVG(tenure_months), 2) as avg_value
FROM `savvy-gtm-analytics.ml_features.v4_1_prospect_features`
UNION ALL
SELECT 'mobility_3yr', COUNT(*), SUM(CASE WHEN mobility_3yr IS NULL THEN 1 ELSE 0 END), ROUND(AVG(mobility_3yr), 2)
FROM `savvy-gtm-analytics.ml_features.v4_1_prospect_features`
UNION ALL
SELECT 'is_recent_mover', COUNT(*), SUM(CASE WHEN is_recent_mover IS NULL THEN 1 ELSE 0 END), ROUND(AVG(is_recent_mover), 2)
FROM `savvy-gtm-analytics.ml_features.v4_1_prospect_features`
UNION ALL
SELECT 'days_since_last_move', COUNT(*), SUM(CASE WHEN days_since_last_move IS NULL THEN 1 ELSE 0 END), ROUND(AVG(days_since_last_move), 2)
FROM `savvy-gtm-analytics.ml_features.v4_1_prospect_features`
UNION ALL
SELECT 'firm_departures_corrected', COUNT(*), SUM(CASE WHEN firm_departures_corrected IS NULL THEN 1 ELSE 0 END), ROUND(AVG(firm_departures_corrected), 2)
FROM `savvy-gtm-analytics.ml_features.v4_1_prospect_features`
UNION ALL
SELECT 'bleeding_velocity_encoded', COUNT(*), SUM(CASE WHEN bleeding_velocity_encoded IS NULL THEN 1 ELSE 0 END), ROUND(AVG(bleeding_velocity_encoded), 2)
FROM `savvy-gtm-analytics.ml_features.v4_1_prospect_features`
UNION ALL
SELECT 'is_dual_registered', COUNT(*), SUM(CASE WHEN is_dual_registered IS NULL THEN 1 ELSE 0 END), ROUND(AVG(is_dual_registered), 2)
FROM `savvy-gtm-analytics.ml_features.v4_1_prospect_features`;

-- 1.3 New V4.1 feature distributions
SELECT 
    'is_recent_mover' as feature,
    is_recent_mover as value,
    COUNT(*) as count,
    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) as pct
FROM `savvy-gtm-analytics.ml_features.v4_1_prospect_features`
GROUP BY is_recent_mover
UNION ALL
SELECT 'bleeding_velocity_encoded', CAST(bleeding_velocity_encoded AS STRING), COUNT(*), ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2)
FROM `savvy-gtm-analytics.ml_features.v4_1_prospect_features`
GROUP BY bleeding_velocity_encoded
UNION ALL
SELECT 'is_dual_registered', CAST(is_dual_registered AS STRING), COUNT(*), ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2)
FROM `savvy-gtm-analytics.ml_features.v4_1_prospect_features`
GROUP BY is_dual_registered;


-- ============================================================================
-- 2. SCORES TABLE VALIDATION
-- ============================================================================

-- 2.1 Basic score statistics
SELECT 
    'v4_1_prospect_scores' as table_name,
    COUNT(*) as total_scored,
    ROUND(AVG(v4_score), 4) as avg_score,
    ROUND(MIN(v4_score), 4) as min_score,
    ROUND(MAX(v4_score), 4) as max_score,
    ROUND(STDDEV(v4_score), 4) as stddev_score
FROM `savvy-gtm-analytics.ml_features.v4_1_prospect_scores`;

-- 2.2 Percentile distribution (should be roughly uniform)
SELECT 
    CASE 
        WHEN v4_percentile <= 10 THEN '0-10'
        WHEN v4_percentile <= 20 THEN '11-20'
        WHEN v4_percentile <= 30 THEN '21-30'
        WHEN v4_percentile <= 40 THEN '31-40'
        WHEN v4_percentile <= 50 THEN '41-50'
        WHEN v4_percentile <= 60 THEN '51-60'
        WHEN v4_percentile <= 70 THEN '61-70'
        WHEN v4_percentile <= 80 THEN '71-80'
        WHEN v4_percentile <= 90 THEN '81-90'
        ELSE '91-100'
    END as percentile_bucket,
    COUNT(*) as count,
    ROUND(AVG(v4_score), 4) as avg_score
FROM `savvy-gtm-analytics.ml_features.v4_1_prospect_scores`
GROUP BY 1
ORDER BY 1;

-- 2.3 Deprioritization flag (should be ~20%)
SELECT 
    v4_deprioritize,
    COUNT(*) as count,
    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) as pct
FROM `savvy-gtm-analytics.ml_features.v4_1_prospect_scores`
GROUP BY v4_deprioritize;


-- ============================================================================
-- 3. V4.0 vs V4.1 SCORE COMPARISON
-- ============================================================================

-- 3.1 Side-by-side comparison (if V4.0 table still exists)
SELECT 
    'V4.0.0' as version,
    COUNT(*) as total,
    ROUND(AVG(v4_score), 4) as avg_score,
    ROUND(APPROX_QUANTILES(v4_score, 10)[OFFSET(9)], 4) as p90_score,
    ROUND(APPROX_QUANTILES(v4_score, 10)[OFFSET(1)], 4) as p10_score
FROM `savvy-gtm-analytics.ml_features.v4_prospect_scores`
UNION ALL
SELECT 
    'V4.1.0' as version,
    COUNT(*) as total,
    ROUND(AVG(v4_score), 4) as avg_score,
    ROUND(APPROX_QUANTILES(v4_score, 10)[OFFSET(9)], 4) as p90_score,
    ROUND(APPROX_QUANTILES(v4_score, 10)[OFFSET(1)], 4) as p10_score
FROM `savvy-gtm-analytics.ml_features.v4_1_prospect_scores`;

-- 3.2 Score correlation between V4.0 and V4.1
SELECT 
    ROUND(CORR(v40.v4_score, v41.v4_score), 4) as score_correlation,
    COUNT(*) as matched_advisors
FROM `savvy-gtm-analytics.ml_features.v4_prospect_scores` v40
JOIN `savvy-gtm-analytics.ml_features.v4_1_prospect_scores` v41 
    ON v40.crd = v41.crd;

-- 3.3 Score changes (who moved up/down the most?)
SELECT 
    'Moved UP (V4.1 > V4.0)' as category,
    COUNT(*) as count,
    ROUND(AVG(v41.v4_percentile - v40.v4_percentile), 2) as avg_percentile_change
FROM `savvy-gtm-analytics.ml_features.v4_prospect_scores` v40
JOIN `savvy-gtm-analytics.ml_features.v4_1_prospect_scores` v41 ON v40.crd = v41.crd
WHERE v41.v4_percentile > v40.v4_percentile
UNION ALL
SELECT 
    'Moved DOWN (V4.1 < V4.0)' as category,
    COUNT(*) as count,
    ROUND(AVG(v41.v4_percentile - v40.v4_percentile), 2) as avg_percentile_change
FROM `savvy-gtm-analytics.ml_features.v4_prospect_scores` v40
JOIN `savvy-gtm-analytics.ml_features.v4_1_prospect_scores` v41 ON v40.crd = v41.crd
WHERE v41.v4_percentile < v40.v4_percentile
UNION ALL
SELECT 
    'No Change' as category,
    COUNT(*) as count,
    0 as avg_percentile_change
FROM `savvy-gtm-analytics.ml_features.v4_prospect_scores` v40
JOIN `savvy-gtm-analytics.ml_features.v4_1_prospect_scores` v41 ON v40.crd = v41.crd
WHERE v41.v4_percentile = v40.v4_percentile;


-- ============================================================================
-- 4. V3/V4.1 DISAGREEMENT FILTER ANALYSIS
-- ============================================================================

-- 4.1 How many T1 leads would be filtered at different thresholds?
WITH tier1_leads AS (
    SELECT 
        sp.crd,
        sp.score_tier,
        v41.v4_percentile
    FROM `savvy-gtm-analytics.ml_features.scored_prospects_v3` sp
    JOIN `savvy-gtm-analytics.ml_features.v4_1_prospect_scores` v41 ON sp.crd = v41.crd
    WHERE sp.score_tier IN (
        'TIER_1A_PRIME_MOVER_CFP', 
        'TIER_1B_PRIME_MOVER_SERIES65',
        'TIER_1_PRIME_MOVER',
        'TIER_1F_HV_WEALTH_BLEEDER'
    )
)
SELECT 
    score_tier,
    COUNT(*) as total_t1,
    SUM(CASE WHEN v4_percentile < 50 THEN 1 ELSE 0 END) as filtered_50th,
    SUM(CASE WHEN v4_percentile < 60 THEN 1 ELSE 0 END) as filtered_60th,
    SUM(CASE WHEN v4_percentile < 70 THEN 1 ELSE 0 END) as filtered_70th,
    ROUND(SUM(CASE WHEN v4_percentile < 60 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 1) as pct_filtered_60th
FROM tier1_leads
GROUP BY score_tier
ORDER BY score_tier;


-- ============================================================================
-- 5. LEAD LIST VALIDATION
-- ============================================================================

-- 5.1 Tier distribution in final list
SELECT 
    score_tier,
    COUNT(*) as leads,
    ROUND(AVG(v4_percentile), 1) as avg_v4_percentile,
    ROUND(AVG(expected_conversion_rate) * 100, 2) as avg_expected_conv_pct
FROM `savvy-gtm-analytics.ml_features.february_2026_lead_list_v41`
GROUP BY score_tier
ORDER BY 
    CASE score_tier
        WHEN 'TIER_1A_PRIME_MOVER_CFP' THEN 1
        WHEN 'TIER_1B_PRIME_MOVER_SERIES65' THEN 2
        WHEN 'TIER_1_PRIME_MOVER' THEN 3
        WHEN 'TIER_1F_HV_WEALTH_BLEEDER' THEN 4
        WHEN 'TIER_2_PROVEN_MOVER' THEN 5
        WHEN 'TIER_3_MODERATE_BLEEDER' THEN 6
        WHEN 'STANDARD_HIGH_V4' THEN 7
        ELSE 99
    END;

-- 5.2 V4.1 feature distributions in final list
SELECT 
    'Recent Movers' as segment,
    SUM(v4_is_recent_mover) as count,
    ROUND(SUM(v4_is_recent_mover) * 100.0 / COUNT(*), 1) as pct
FROM `savvy-gtm-analytics.ml_features.february_2026_lead_list_v41`
UNION ALL
SELECT 
    'Dual Registered' as segment,
    SUM(v4_is_dual_registered) as count,
    ROUND(SUM(v4_is_dual_registered) * 100.0 / COUNT(*), 1) as pct
FROM `savvy-gtm-analytics.ml_features.february_2026_lead_list_v41`
UNION ALL
SELECT 
    'Accelerating Bleed Firms' as segment,
    SUM(CASE WHEN v4_bleeding_velocity_encoded = 3 THEN 1 ELSE 0 END) as count,
    ROUND(SUM(CASE WHEN v4_bleeding_velocity_encoded = 3 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 1) as pct
FROM `savvy-gtm-analytics.ml_features.february_2026_lead_list_v41`;

-- 5.3 SGA distribution
SELECT 
    sga_owner,
    COUNT(*) as leads,
    ROUND(AVG(expected_conversion_rate) * 100, 2) as avg_expected_conv_pct,
    ROUND(AVG(v4_percentile), 1) as avg_v4_percentile
FROM `savvy-gtm-analytics.ml_features.february_2026_lead_list_v41`
GROUP BY sga_owner
ORDER BY leads DESC;


-- ============================================================================
-- 6. FINAL VALIDATION SUMMARY
-- ============================================================================

SELECT 
    'Features Table' as component,
    CASE WHEN COUNT(*) > 200000 THEN 'âœ… PASS' ELSE 'âŒ FAIL' END as status,
    CONCAT(CAST(COUNT(*) AS STRING), ' rows') as detail
FROM `savvy-gtm-analytics.ml_features.v4_1_prospect_features`
UNION ALL
SELECT 
    'Scores Table' as component,
    CASE WHEN COUNT(*) > 200000 THEN 'âœ… PASS' ELSE 'âŒ FAIL' END as status,
    CONCAT(CAST(COUNT(*) AS STRING), ' rows') as detail
FROM `savvy-gtm-analytics.ml_features.v4_1_prospect_scores`
UNION ALL
SELECT 
    'Deprioritize ~20%' as component,
    CASE WHEN ABS(pct - 20) < 3 THEN 'âœ… PASS' ELSE 'âš ï¸ CHECK' END as status,
    CONCAT(CAST(ROUND(pct, 1) AS STRING), '% deprioritized') as detail
FROM (
    SELECT SUM(CASE WHEN v4_deprioritize THEN 1 ELSE 0 END) * 100.0 / COUNT(*) as pct
    FROM `savvy-gtm-analytics.ml_features.v4_1_prospect_scores`
)
UNION ALL
SELECT 
    'Lead List' as component,
    CASE WHEN COUNT(*) BETWEEN 2500 AND 3000 THEN 'âœ… PASS' ELSE 'âš ï¸ CHECK' END as status,
    CONCAT(CAST(COUNT(*) AS STRING), ' leads') as detail
FROM `savvy-gtm-analytics.ml_features.february_2026_lead_list_v41`;
```

### Verification 6.1

```
@workspace Verify validation queries file is complete.

Check in pipeline/sql/v4_1_validation_queries.sql:
1. File exists and has all 6 sections
2. Feature table validation queries present
3. Scores table validation queries present
4. V4.0 vs V4.1 comparison queries present
5. Disagreement filter analysis present
6. Lead list validation present
7. Final summary validation present

Update pipeline/logs/V4.1_INTEGRATION_LOG.md with results.
```

---

## Step 7: Final Verification Checklist

### Cursor Prompt 7.1

```
@workspace Complete final verification of V4.1 integration.

WORKING DIRECTORY: C:\Users\russe\Documents\lead_scoring_production

Final verification tasks:
1. Verify all files created:
   - pipeline/logs/V4.1_INTEGRATION_LOG.md
   - pipeline/sql/v4_1_prospect_features.sql
   - pipeline/sql/February_2026_Lead_List_V3_V4_1_Hybrid.sql
   - pipeline/sql/v4_1_validation_queries.sql

2. Verify all files updated:
   - pipeline/scripts/score_prospects_monthly.py (V4.1 paths)
   - README.md (V4.1 section added)

3. Run syntax validation on SQL files (no execution, just check)

4. Create final summary in execution log

5. Mark integration as COMPLETE

Execute now.
```

### Final Checklist

```markdown
## V4.1-R3 Integration Final Checklist

### Files Created
- [ ] pipeline/logs/V4.1_INTEGRATION_LOG.md
- [ ] pipeline/sql/v4_1_prospect_features.sql
- [ ] pipeline/sql/February_2026_Lead_List_V3_V4_1_Hybrid.sql
- [ ] pipeline/sql/v4_1_validation_queries.sql

### Files Updated
- [ ] pipeline/scripts/score_prospects_monthly.py
  - [ ] V4_MODEL_DIR â†’ v4/models/v4.1.0
  - [ ] V4_FEATURES_FILE â†’ v4/data/v4.1.0/final_features.json
  - [ ] FEATURES_TABLE â†’ v4_1_prospect_features
  - [ ] SCORES_TABLE â†’ v4_1_prospect_scores
- [ ] README.md
  - [ ] V4.1.0 R3 section added
  - [ ] Performance comparison table
  - [ ] Feature list (22 features)
  - [ ] Pipeline architecture diagram

### SQL Validation
- [ ] v4_1_prospect_features.sql - No syntax errors
- [ ] February_2026_Lead_List_V3_V4_1_Hybrid.sql - No syntax errors
- [ ] v4_1_validation_queries.sql - No syntax errors

### Model Files Verified
- [ ] v4/models/v4.1.0/model.pkl exists
- [ ] v4/data/v4.1.0/final_features.json exists
- [ ] final_features.json contains 22 features

### Integration Complete
- [ ] Execution log updated with all steps
- [ ] All verification steps passed
- [ ] Ready for BigQuery execution
```

### Post-Integration Steps (Manual)

After Cursor completes the integration, manually execute:

```bash
# 1. Run feature engineering in BigQuery
bq query --use_legacy_sql=false < pipeline/sql/v4_1_prospect_features.sql

# 2. Run monthly scoring
python pipeline/scripts/score_prospects_monthly.py

# 3. Run lead list generation
bq query --use_legacy_sql=false < pipeline/sql/February_2026_Lead_List_V3_V4_1_Hybrid.sql

# 4. Run validation queries
bq query --use_legacy_sql=false < pipeline/sql/v4_1_validation_queries.sql
```

---

## Appendix A: Rollback Instructions

If V4.1 integration fails or performance degrades:

### Cursor Prompt (Rollback)

```
@workspace Rollback V4.1 integration to V4.0.0.

WORKING DIRECTORY: C:\Users\russe\Documents\lead_scoring_production

Tasks:
1. Revert score_prospects_monthly.py to V4.0.0 paths:
   - V4_MODEL_DIR = v4/models/v4.0.0
   - V4_FEATURES_FILE = v4/data/processed/final_features.json
   - FEATURES_TABLE = v4_prospect_features
   - SCORES_TABLE = v4_prospect_scores

2. Use January_2026_Lead_List_V3_V4_Hybrid.sql for lead generation

3. Update execution log with rollback reason

4. Do NOT delete V4.1 files (keep for future reference)

Execute now.
```

---

## Appendix B: Support Resources

| Resource | Location |
|----------|----------|
| V4.1 Final Summary | `v4/reports/v4.1/V4.1_Final_Summary.md` |
| V4.1 Validation Report | `v4/reports/v4.1/model_validation_report_r3.md` |
| V4.1 Training Log | `v4/EXECUTION_LOG_V4.1.md` |
| V4.1 Deployment Checklist | `v4/DEPLOYMENT_CHECKLIST_V4.1.md` |
| Model Registry | `v4/models/registry.json` |

---

**Document End**

**Created**: 2025-12-30  
**Purpose**: Cursor.ai automation guide for V4.1-R3 pipeline integration  
**Total Steps**: 7  
**Estimated Time**: 30-45 minutes (Cursor execution)
