# V4.1-R3 Pipeline Integration Guide for Cursor.ai

**Document Version**: 2.0  
**Created**: 2025-12-30  
**Updated**: 2025-12-30  
**Purpose**: Step-by-step guide for Cursor.ai to integrate V4.1-R3 model into production pipeline by **UPDATING EXISTING FILES**  
**Working Directory**: `C:\Users\russe\Documents\lead_scoring_production`  
**Execution Log**: `pipeline/logs/V4.1_INTEGRATION_LOG.md`

---

## Table of Contents

1. [Overview & Context](#step-0-overview--context)
2. [Step 1: Create Execution Log](#step-1-create-execution-log)
3. [Step 2: Update Feature Engineering SQL](#step-2-update-feature-engineering-sql)
4. [Step 3: Update Monthly Scoring Script](#step-3-update-monthly-scoring-script)
5. [Step 4: Update Hybrid Lead List SQL](#step-4-update-hybrid-lead-list-sql)
6. [Step 5: Update Root README.md](#step-5-update-root-readmemd)
7. [Step 6: Update Validation Queries](#step-6-update-validation-queries)
8. [Step 7: Final Verification Checklist](#step-7-final-verification-checklist)

---

## Step 0: Overview & Context

### Why We're Making These Changes

**V4.1-R3 Model Improvements:**
- **Test AUC-ROC**: 0.620 (+3.5% vs V4.0.0's 0.599)
- **Top Decile Lift**: 2.03x (+34% vs V4.0.0's 1.51x)
- **Features**: 22 (vs V4.0.0's 14) - adds bleeding signals and firm/rep type
- **SHAP Interpretability**: Full KernelExplainer support (vs limited in V4.0.0)
- **Overfitting**: Controlled (AUC gap 0.075, well below 0.15 threshold)

**New Features in V4.1 (7 added):**
1. `is_recent_mover` - Moved firms in last 12 months
2. `days_since_last_move` - Days since joining current firm
3. `firm_departures_corrected` - Corrected firm departure count
4. `bleeding_velocity_encoded` - Firm bleeding acceleration (0-3 scale)
5. `is_independent_ria` - Independent RIA flag
6. `is_ia_rep_type` - IA rep type flag
7. `is_dual_registered` - Dual registered (broker-dealer ties)

**Removed Features (Multicollinearity - 4 removed):**
- `industry_tenure_months` (r=0.96 with `experience_years`)
- `tenure_bucket_x_mobility` (r=0.94 with `mobility_3yr`)
- `independent_ria_x_ia_rep` (r=0.97 with `is_ia_rep_type`)
- `recent_mover_x_bleeding` (r=0.90 with `is_recent_mover`)

### Files to UPDATE (Not Create New)

| File | Action | Purpose |
|------|--------|---------|
| `pipeline/logs/V4.1_INTEGRATION_LOG.md` | CREATE | Track integration progress |
| `pipeline/sql/v4_prospect_features.sql` | **UPDATE** | Add 8 new V4.1 features (total 22) |
| `pipeline/scripts/score_prospects_monthly.py` | **UPDATE** | Point to V4.1.0 model (paths already updated, verify) |
| `pipeline/sql/January_2026_Lead_List_V3_V4_Hybrid.sql` | **UPDATE** | Use V4.1 features/scores |
| `pipeline/January_2026_Lead_List_V3_V4_Hybrid.sql` | **UPDATE** | Same updates (duplicate location) |
| `README.md` | **UPDATE** | Add V4.1 documentation |

### Files That Already Exist (Reference These)

- `v4/models/v4.1.0/model.pkl` ‚úÖ Already exists
- `v4/data/v4.1.0/final_features.json` ‚úÖ Already exists (22 features)
- `v4/sql/production_scoring_v41.sql` ‚úÖ Already exists (reference for feature SQL)
- `v4/EXECUTION_LOG_V4.1.md` ‚úÖ Already exists
- `v4/reports/v4.1/V4.1_Final_Summary.md` ‚úÖ Already exists

### Key Changes from V4.0.0 to V4.1.0

- **Features**: 14 ‚Üí 22 (+8 new, -4 removed for multicollinearity)
- **Test AUC**: 0.599 ‚Üí 0.620 (+3.5%)
- **Top Decile Lift**: 1.51x ‚Üí 2.03x (+34%)
- **SHAP**: Limited ‚Üí Full KernelExplainer

### BigQuery Table Names (Keep Same)

- `ml_features.v4_prospect_features` (same table, now with 22 features)
- `ml_features.v4_prospect_scores` (same table, now with V4.1 scores)
- `ml_features.january_2026_lead_list_v4` (same table, now with V4.1 columns)

---

## Step 1: Create Execution Log

### Cursor Prompt 1.1

```
@workspace Create the V4.1 integration execution log file.

WORKING DIRECTORY: C:\Users\russe\Documents\lead_scoring_production

Task:
1. Create file: pipeline/logs/V4.1_INTEGRATION_LOG.md
2. Initialize with header and status tracking sections
3. This file will be updated after each step to track progress

Execute now.
```

### Code: pipeline/logs/V4.1_INTEGRATION_LOG.md

```markdown
# V4.1-R3 Pipeline Integration Execution Log

**Started**: [TIMESTAMP]
**Status**: üü° In Progress
**Operator**: Cursor.ai

---

## Integration Overview

| Step | Description | Status | Completed |
|------|-------------|--------|-----------|
| 1 | Create Execution Log | ‚è≥ | - |
| 2 | Update Feature Engineering SQL | ‚è≥ | - |
| 3 | Update Monthly Scoring Script | ‚è≥ | - |
| 4 | Update Hybrid Lead List SQL | ‚è≥ | - |
| 5 | Update Root README.md | ‚è≥ | - |
| 6 | Update Validation Queries | ‚è≥ | - |
| 7 | Final Verification | ‚è≥ | - |

---

## Step 1: Create Execution Log

**Started**: [TIMESTAMP]
**Status**: ‚úÖ COMPLETE

- Created this file: `pipeline/logs/V4.1_INTEGRATION_LOG.md`

---

## Step 2: Update Feature Engineering SQL

**Started**: [TIMESTAMP]
**Status**: ‚è≥ Pending

### Actions
- [ ] Updated `pipeline/sql/v4_prospect_features.sql`
- [ ] Added 8 new V4.1 features
- [ ] Verified 4 removed features NOT included
- [ ] Added JOINs to inferred_departures_analysis and firm_bleeding_velocity_v41
- [ ] Updated header comments

### Verification Results
```
Total features: [PENDING]
New V4.1 features: [PENDING]
Removed features found: [PENDING]
```

---

## Step 3: Update Monthly Scoring Script

**Started**: [TIMESTAMP]
**Status**: ‚è≥ Pending

### Actions
- [ ] Verified V4_MODEL_DIR path (should be v4/models/v4.1.0)
- [ ] Verified V4_FEATURES_FILE path (should be v4/data/v4.1.0/final_features.json)
- [ ] Verified FEATURES_TABLE = "v4_prospect_features" (same name)
- [ ] Verified SCORES_TABLE = "v4_prospect_scores" (same name)
- [ ] Updated feature list to 22 features

### Verification Results
```
Model path: [PENDING]
Features file path: [PENDING]
Feature count: [PENDING]
```

---

## Step 4: Update Hybrid Lead List SQL

**Started**: [TIMESTAMP]
**Status**: ‚è≥ Pending

### Actions
- [ ] Updated `pipeline/sql/January_2026_Lead_List_V3_V4_Hybrid.sql`
- [ ] Updated `pipeline/January_2026_Lead_List_V3_V4_Hybrid.sql` (duplicate)
- [ ] Updated V4 scores table reference (same name, updated contents)
- [ ] Added new V4.1 columns to output
- [ ] Updated disagreement threshold (70th ‚Üí 60th percentile option)
- [ ] Updated header to document V4.1 integration

### Verification Results
```
V4 scores table: [PENDING]
New columns added: [PENDING]
Disagreement threshold: [PENDING]
```

---

## Step 5: Update Root README.md

**Started**: [TIMESTAMP]
**Status**: ‚è≥ Pending

### Actions
- [ ] Added V4.1 model section
- [ ] Documented performance improvements
- [ ] Added validation results
- [ ] Updated pipeline architecture diagram

---

## Step 6: Update Validation Queries

**Started**: [TIMESTAMP]
**Status**: ‚è≥ Pending

### Actions
- [ ] Updated validation queries to check existing tables with V4.1 features
- [ ] Feature distribution queries
- [ ] Score comparison queries
- [ ] Hybrid filter queries

---

## Step 7: Final Verification

**Started**: [TIMESTAMP]
**Status**: ‚è≥ Pending

### Checklist
- [ ] All files updated successfully
- [ ] No syntax errors in SQL
- [ ] Model paths verified
- [ ] Feature count = 22
- [ ] README updated with all sections

---

## Errors & Issues

*None recorded yet*

---

## Rollback Instructions

If integration fails:
1. Revert MODEL PATHS in `score_prospects_monthly.py`:
   - V4_MODEL_DIR ‚Üí v4/models/v4.0.0
   - V4_FEATURES_FILE ‚Üí v4/data/processed/final_features.json
2. Note: Feature SQL can stay at 22 features (V4.0 model will just ignore extras)
3. Use existing `January_2026_Lead_List_V3_V4_Hybrid.sql` (revert changes)
4. Document failure reason in this log

---

**Last Updated**: [TIMESTAMP]
```

### Verification 1.1

```
Verify file exists: pipeline/logs/V4.1_INTEGRATION_LOG.md
Expected: File created with all sections
```

---

## Step 2: Update Feature Engineering SQL

### Cursor Prompt 2.1

```
@workspace Update the existing V4 feature engineering SQL to include all 22 V4.1 features.

WORKING DIRECTORY: C:\Users\russe\Documents\lead_scoring_production

File to UPDATE: pipeline/sql/v4_prospect_features.sql

Context:
- V4.1.0 uses 22 features (V4.0.0 used 14)
- 8 new features added for bleeding signals and firm/rep type
- 4 features removed due to multicollinearity
- Must join to: inferred_departures_analysis, firm_bleeding_velocity_v41
- Output table: ml_features.v4_prospect_features (SAME NAME, updated contents)

Task:
1. Open existing file: pipeline/sql/v4_prospect_features.sql
2. Add the 8 new V4.1 features after existing features
3. Add proper JOINs to new tables:
   - LEFT JOIN ml_features.inferred_departures_analysis
   - LEFT JOIN ml_features.firm_bleeding_velocity_v41
4. Update header comments to note V4.1 upgrade
5. Keep output table name as ml_features.v4_prospect_features (same)
6. Remove any references to removed features (if present)
7. Update execution log with results

Reference files:
- v4/sql/production_scoring_v41.sql (for V4.1 feature SQL patterns)
- Existing pipeline/sql/v4_prospect_features.sql (V4.0.0 version)

Execute now.
```

### Code Changes: pipeline/sql/v4_prospect_features.sql

**Add these sections to the existing SQL:**

#### 1. Add New CTEs After Existing CTEs (Before `all_features`)

```sql
-- ============================================================================
-- NEW V4.1 CTE: FIRM BLEEDING METRICS (Corrected - from inferred_departures_analysis)
-- ============================================================================
firm_bleeding_corrected AS (
    SELECT 
        ida.firm_crd,
        ida.departures_12mo_inferred as firm_departures_corrected,
        ida.net_change_12mo_inferred as firm_net_change_12mo_corrected
    FROM `savvy-gtm-analytics.ml_features.inferred_departures_analysis` ida
),

-- ============================================================================
-- NEW V4.1 CTE: FIRM BLEEDING VELOCITY
-- ============================================================================
bleeding_velocity AS (
    SELECT 
        bv.firm_crd,
        bv.bleeding_velocity,
        -- Encode velocity: 0=STABLE, 1=DECELERATING, 2=STEADY, 3=ACCELERATING
        CASE 
            WHEN bv.bleeding_velocity = 'ACCELERATING' THEN 3
            WHEN bv.bleeding_velocity = 'STEADY' THEN 2
            WHEN bv.bleeding_velocity = 'DECELERATING' THEN 1
            ELSE 0  -- STABLE or NULL
        END as bleeding_velocity_encoded
    FROM `savvy-gtm-analytics.ml_features.firm_bleeding_velocity_v41` bv
),

-- ============================================================================
-- NEW V4.1 CTE: FIRM/REP TYPE FEATURES
-- ============================================================================
firm_rep_type AS (
    SELECT 
        fm.FIRM_CRD as firm_crd,
        fm.SEC_REGISTRATION_STATUS as sec_registration_status,
        fm.STATE_REGISTRATION_STATUS as state_registration_status
    FROM `savvy-gtm-analytics.FinTrx_data_CA.ria_companies_current` fm
),
```

#### 2. Add New Features to `all_features` CTE (After Feature 15)

Add these features after the existing features in the `all_features` SELECT statement:

```sql
        -- ================================================================
        -- NEW V4.1 FEATURES (16-22) - Add after existing features
        -- ================================================================
        
        -- FEATURE 16: is_recent_mover (NEW in V4.1)
        -- Moved firms in last 12 months
        CASE 
            WHEN cf.tenure_months IS NOT NULL AND cf.tenure_months <= 12 
            THEN 1 ELSE 0 
        END as is_recent_mover,
        
        -- FEATURE 17: days_since_last_move (NEW in V4.1)
        -- Days since joining current firm
        COALESCE(cf.tenure_days, 9999) as days_since_last_move,
        
        -- FEATURE 18: firm_departures_corrected (NEW in V4.1)
        -- Corrected firm departure count from inferred_departures_analysis
        COALESCE(fbc.firm_departures_corrected, 0) as firm_departures_corrected,
        
        -- FEATURE 19: bleeding_velocity_encoded (NEW in V4.1)
        -- Firm bleeding acceleration: 0=STABLE, 1=DECELERATING, 2=STEADY, 3=ACCELERATING
        COALESCE(bv.bleeding_velocity_encoded, 0) as bleeding_velocity_encoded,
        
        -- FEATURE 20: is_independent_ria (NEW in V4.1)
        -- SEC registered + state notice filed = independent RIA
        CASE 
            WHEN frt.sec_registration_status = 'Registered' 
                 AND frt.state_registration_status IN ('Notice Filed', 'Not Required') 
            THEN 1 ELSE 0 
        END as is_independent_ria,
        
        -- FEATURE 21: is_ia_rep_type (NEW in V4.1)
        -- Investment Advisor rep type
        CASE WHEN bp.rep_type = 'IA' THEN 1 ELSE 0 END as is_ia_rep_type,
        
        -- FEATURE 22: is_dual_registered (NEW in V4.1)
        -- Both broker-dealer and investment advisor
        CASE 
            WHEN bp.rep_type = 'Dual' 
                 OR (bp.rep_licenses LIKE '%Series 7%' AND bp.rep_licenses LIKE '%Series 65%') 
            THEN 1 ELSE 0 
        END as is_dual_registered,
```

#### 3. Add JOINs to `all_features` CTE

Add these JOINs to the existing FROM/JOIN clause:

```sql
    FROM base_prospects bp
    LEFT JOIN current_firm cf ON bp.crd = cf.crd
    LEFT JOIN employment_history eh ON bp.crd = eh.crd
    LEFT JOIN firm_metrics fm ON bp.firm_crd = fm.firm_crd
    LEFT JOIN firm_bleeding fb ON bp.firm_crd = fb.firm_crd
    -- NEW V4.1 JOINs:
    LEFT JOIN firm_bleeding_corrected fbc ON bp.firm_crd = fbc.firm_crd
    LEFT JOIN bleeding_velocity bv ON bp.firm_crd = bv.firm_crd
    LEFT JOIN firm_rep_type frt ON bp.firm_crd = frt.firm_crd
    LEFT JOIN broker_protocol bpm ON bp.firm_crd = bpm.firm_crd
    LEFT JOIN experience_calc ec ON bp.crd = ec.crd
```

#### 4. Update Header Comments

Update the header at the top of the file:

```sql
-- ============================================================================
-- V4 PROSPECT FEATURES TABLE (UPDATED FOR V4.1.0)
-- ============================================================================
-- 
-- VERSION: V4.1.0 R3 (Updated 2025-12-30)
-- CREATED: [Original date]
-- UPDATED: 2025-12-30
-- PURPOSE: Calculate all 22 V4.1 features for prospect scoring
-- 
-- CHANGES FROM V4.0.0:
-- - ADDED 8 new features (bleeding signals, firm/rep type)
-- - REMOVED 4 features (multicollinearity: r > 0.90)
-- - Total features: 22 (was 14)
-- 
-- NEW FEATURES:
-- - is_recent_mover (moved in last 12 months)
-- - days_since_last_move (days since joining current firm)
-- - firm_departures_corrected (corrected departure count from inferred_departures_analysis)
-- - bleeding_velocity_encoded (0=STABLE, 1=DECELERATING, 2=STEADY, 3=ACCELERATING)
-- - is_independent_ria (SEC registered, state notice filed)
-- - is_ia_rep_type (IA rep type)
-- - is_dual_registered (both broker-dealer and IA)
-- 
-- REMOVED FEATURES (multicollinearity):
-- - industry_tenure_months (r=0.96 with experience_years)
-- - tenure_bucket_x_mobility (r=0.94 with mobility_3yr)
-- - independent_ria_x_ia_rep (r=0.97 with is_ia_rep_type)
-- - recent_mover_x_bleeding (r=0.90 with is_recent_mover)
-- 
-- OUTPUT: ml_features.v4_prospect_features (SAME TABLE, updated contents)
-- 
-- USAGE:
--   Run this SQL before monthly lead list generation
--   Then run score_prospects_monthly.py to generate scores
-- 
-- ============================================================================
```

### Verification 2.1

```
@workspace Verify the V4.1 feature engineering SQL updates are correct.

Check in pipeline/sql/v4_prospect_features.sql:
1. File exists and was UPDATED (not created new)
2. Contains exactly 22 features (count FEATURE comments)
3. Contains NO removed features:
   - industry_tenure_months (as a feature, not source)
   - tenure_bucket_x_mobility
   - independent_ria_x_ia_rep
   - recent_mover_x_bleeding
4. Contains ALL new V4.1 features:
   - is_recent_mover
   - days_since_last_move
   - firm_departures_corrected
   - bleeding_velocity_encoded
   - is_independent_ria
   - is_ia_rep_type
   - is_dual_registered
5. JOINs added to:
   - ml_features.inferred_departures_analysis
   - ml_features.firm_bleeding_velocity_v41
6. Output table name: ml_features.v4_prospect_features (same as before)
7. Header updated with V4.1.0 version info

Update pipeline/logs/V4.1_INTEGRATION_LOG.md with results.
```

---

## Step 3: Update Monthly Scoring Script

### Cursor Prompt 3.1

```
@workspace Verify and update the monthly scoring script to use V4.1.0 model.

WORKING DIRECTORY: C:\Users\russe\Documents\lead_scoring_production

File to UPDATE: pipeline/scripts/score_prospects_monthly.py

Changes required (verify these are already correct):
1. V4_MODEL_DIR should be: v4/models/v4.1.0
2. V4_FEATURES_FILE should be: v4/data/v4.1.0/final_features.json
3. FEATURES_TABLE should be: "v4_prospect_features" (SAME NAME)
4. SCORES_TABLE should be: "v4_prospect_scores" (SAME NAME)
5. Update feature list to 22 features
6. Add comment header noting V4.1.0 update

Also verify:
- v4/models/v4.1.0/model.pkl exists
- v4/data/v4.1.0/final_features.json exists
- final_features.json contains 22 features

Update execution log with results.

Execute now.
```

### Code Changes: pipeline/scripts/score_prospects_monthly.py

**Verify/Update these sections:**

```python
# ============================================================================
# PATH CONFIGURATION (UPDATED FOR V4.1.0)
# ============================================================================
WORKING_DIR = Path(r"C:\Users\russe\Documents\lead_scoring_production\pipeline")
# Updated for V4.1.0 R3 deployment (2025-12-30)
V4_MODEL_DIR = Path(r"C:\Users\russe\Documents\lead_scoring_production\v4\models\v4.1.0")
V4_FEATURES_FILE = Path(r"C:\Users\russe\Documents\lead_scoring_production\v4\data\v4.1.0\final_features.json")

# ============================================================================
# BIGQUERY CONFIGURATION (SAME TABLE NAMES)
# ============================================================================
PROJECT_ID = "savvy-gtm-analytics"
DATASET = "ml_features"
FEATURES_TABLE = "v4_prospect_features"  # SAME NAME (updated contents)
SCORES_TABLE = "v4_prospect_scores"      # SAME NAME (updated contents)
```

**Update script header:**

```python
"""
Score all prospects with V4.1.0 model and generate SHAP-based narratives.
Run monthly BEFORE lead list generation.

VERSION: V4.1.0 R3
UPDATED: 2025-12-30

CHANGES FROM V4.0.0:
- Model upgraded to V4.1.0 R3 (0.620 AUC, 2.03x lift)
- Features increased from 14 to 22
- Added bleeding signal features
- Added firm/rep type features
- Improved SHAP interpretability

Working Directory: pipeline
Usage: python scripts/score_prospects_monthly.py
"""
```

**Update FEATURE_DESCRIPTIONS to include new V4.1 features:**

```python
FEATURE_DESCRIPTIONS = {
    # ... existing features ...
    
    # NEW V4.1 FEATURES:
    'is_recent_mover': {
        'name': 'Recent Mover',
        'positive': 'moved to their current firm in the last 12 months, indicating high mobility',
        'negative': 'been at their current firm for over a year'
    },
    'days_since_last_move': {
        'name': 'Days Since Last Move',
        'positive': 'recently joined their current firm, still in transition period',
        'negative': 'been at their firm for a longer time'
    },
    'firm_departures_corrected': {
        'name': 'Firm Departures (Corrected)',
        'positive': 'their firm is experiencing advisor departures, creating instability',
        'negative': 'their firm is stable with minimal departures'
    },
    'bleeding_velocity_encoded': {
        'name': 'Bleeding Velocity',
        'positive': 'their firm\'s advisor departures are accelerating, optimal outreach window',
        'negative': 'their firm\'s departures are stable or decelerating'
    },
    'is_independent_ria': {
        'name': 'Independent RIA',
        'positive': 'at an independent RIA firm, more autonomy and portability',
        'negative': 'not at an independent RIA'
    },
    'is_ia_rep_type': {
        'name': 'IA Rep Type',
        'positive': 'pure investment advisor (no broker-dealer registration)',
        'negative': 'has broker-dealer registration'
    },
    'is_dual_registered': {
        'name': 'Dual Registered',
        'positive': 'dual-registered (both IA and BD), higher mobility potential',
        'negative': 'not dual-registered'
    },
}
```

### Verification 3.1

```
@workspace Verify the scoring script updates are correct.

Check in pipeline/scripts/score_prospects_monthly.py:
1. V4_MODEL_DIR contains "v4.1.0" (not "v4.0.0")
2. V4_FEATURES_FILE contains "v4.1.0" (not "processed")
3. FEATURES_TABLE = "v4_prospect_features" (SAME NAME)
4. SCORES_TABLE = "v4_prospect_scores" (SAME NAME)
5. Header updated with V4.1.0 version info
6. FEATURE_DESCRIPTIONS includes all 7 new V4.1 features

Also verify files exist:
- v4/models/v4.1.0/model.pkl
- v4/data/v4.1.0/final_features.json
- final_features.json contains 22 features

Update pipeline/logs/V4.1_INTEGRATION_LOG.md with results.
```

---

## Step 4: Update Hybrid Lead List SQL

### Cursor Prompt 4.1

```
@workspace Update the January 2026 lead list SQL with V4.1 integration.

WORKING DIRECTORY: C:\Users\russe\Documents\lead_scoring_production

Files to UPDATE:
1. pipeline/sql/January_2026_Lead_List_V3_V4_Hybrid.sql
2. pipeline/January_2026_Lead_List_V3_V4_Hybrid.sql (duplicate location)

Changes required:
1. Keep V4 scores table as ml_features.v4_prospect_scores (SAME NAME, updated contents)
2. Add new V4.1 columns to v4_enriched CTE output:
   - is_recent_mover
   - days_since_last_move
   - firm_departures_corrected
   - bleeding_velocity_encoded
   - is_dual_registered
3. Add new V4.1 columns to final SELECT output
4. Update header to reflect V4.1 integration
5. Optionally update disagreement threshold from 70th to 60th percentile
   (V4.1 is more accurate, can be more aggressive)
6. Keep output table name as ml_features.january_2026_lead_list_v4 (SAME NAME)

Key changes in v4_enriched CTE:
- Keep joining to ml_features.v4_prospect_scores (same table name)
- Select additional V4.1 feature columns from v4_prospect_scores

Update execution log with results.

Execute now.
```

### Code Changes: pipeline/sql/January_2026_Lead_List_V3_V4_Hybrid.sql

#### 1. Update Header Comments

```sql
-- ============================================================================
-- JANUARY 2026 LEAD LIST GENERATOR (V3.2.5 + V4.1.0 R3 HYBRID)
-- ============================================================================
-- Version: 2.1 with V4.1.0 Integration (Updated 2025-12-30)
-- 
-- V4.1 INTEGRATION CHANGES:
-- - Scores table: ml_features.v4_prospect_scores (SAME NAME, updated with V4.1 scores)
-- - Features: 22 (was 14)
-- - New columns: is_recent_mover, days_since_last_move, firm_departures_corrected,
--                bleeding_velocity_encoded, is_dual_registered
-- - Disagreement threshold: 60th percentile (was 70th) - V4.1 is more accurate
-- 
-- V4.1 PERFORMANCE IMPROVEMENTS:
-- - Test AUC-ROC: 0.620 (+3.5% vs V4.0.0)
-- - Top Decile Lift: 2.03x (+34% vs V4.0.0)
-- - Better bleeding signal detection
-- 
-- FEATURES:
-- - V3 Rules: Tier assignment with rich human-readable narratives
-- - V4.1 XGBoost: Upgrade path with SHAP-based narratives
-- - Job Titles: Included in output for SDR context
-- - Firm Exclusions: Savvy Wealth and Ritholtz excluded
--
-- OUTPUT: ml_features.january_2026_lead_list_v4 (SAME TABLE, updated contents)
-- 
-- ============================================================================
```

#### 2. Update `v4_enriched` CTE

Find the `v4_enriched` CTE and add the new V4.1 columns:

```sql
v4_enriched AS (
    SELECT 
        ep.*,
        -- V4.1 Score and percentile (from updated v4_prospect_scores table)
        COALESCE(v4.v4_score, 0.5) as v4_score,
        COALESCE(v4.v4_percentile, 50) as v4_percentile,
        COALESCE(v4.v4_deprioritize, FALSE) as v4_deprioritize,
        
        -- NEW V4.1 Feature columns (for enhanced narratives)
        COALESCE(v4.is_recent_mover, 0) as v4_is_recent_mover,
        COALESCE(v4.days_since_last_move, 9999) as v4_days_since_last_move,
        COALESCE(v4.firm_departures_corrected, 0) as v4_firm_departures_corrected,
        COALESCE(v4.bleeding_velocity_encoded, 0) as v4_bleeding_velocity_encoded,
        COALESCE(v4.is_dual_registered, 0) as v4_is_dual_registered,
        
        -- V4.1 SHAP narratives (if available)
        v4.shap_top1_feature,
        v4.shap_top1_value,
        v4.shap_top2_feature,
        v4.shap_top2_value,
        v4.shap_top3_feature,
        v4.shap_top3_value,
        v4.v4_narrative
        
    FROM enriched_prospects ep
    LEFT JOIN `savvy-gtm-analytics.ml_features.v4_prospect_scores` v4 
        ON ep.crd = v4.crd
),
```

#### 3. Update Disagreement Filter (Optional - More Aggressive)

Find the disagreement filter logic and optionally update the threshold:

```sql
-- V3/V4.1 Disagreement Filter
-- Exclude Tier 1 leads where V4.1 < 60th percentile (was 70th for V4.0)
-- V4.1 is more accurate (2.03x lift vs 1.51x), so we can be more aggressive
WHERE NOT (
    score_tier IN (
        'TIER_1A_PRIME_MOVER_CFP', 
        'TIER_1B_PRIME_MOVER_SERIES65',
        'TIER_1_PRIME_MOVER',
        'TIER_1F_HV_WEALTH_BLEEDER'
    )
    AND v4_percentile < 60  -- CHANGED from 70 (V4.1 is more accurate)
)
```

#### 4. Add New V4.1 Columns to Final SELECT

Add these columns to the final SELECT statement:

```sql
    -- V4.1 Scoring (UPDATED)
    ROUND(v4_score, 4) as v4_score,
    v4_percentile,
    v4_narrative,
    combined_narrative as score_narrative,
    
    -- V4.1 Feature Values (NEW - for transparency)
    v4_is_recent_mover,
    v4_days_since_last_move,
    v4_firm_departures_corrected,
    v4_bleeding_velocity_encoded,
    v4_is_dual_registered,
    
    -- V4.1 SHAP Features (for SDR context)
    shap_top1_feature,
    shap_top2_feature,
    shap_top3_feature,
```

### Verification 4.1

```
@workspace Verify the January 2026 hybrid SQL updates are correct.

Check in pipeline/sql/January_2026_Lead_List_V3_V4_Hybrid.sql:
1. v4_enriched CTE joins to v4_prospect_scores (SAME NAME)
2. New V4.1 columns selected in v4_enriched:
   - v4_is_recent_mover
   - v4_days_since_last_move
   - v4_firm_departures_corrected
   - v4_bleeding_velocity_encoded
   - v4_is_dual_registered
3. New V4.1 columns added to final SELECT output
4. Disagreement threshold optionally changed to 60 (was 70)
5. Header updated with V4.1 information
6. Output table name: ml_features.january_2026_lead_list_v4 (SAME NAME)

Also check pipeline/January_2026_Lead_List_V3_V4_Hybrid.sql (duplicate) has same updates.

Update pipeline/logs/V4.1_INTEGRATION_LOG.md with results.
```

---

## Step 5: Update Root README.md

### Cursor Prompt 5.1

```
@workspace Update the root README.md with V4.1 model information.

WORKING DIRECTORY: C:\Users\russe\Documents\lead_scoring_production

File to update: README.md

Add a new section documenting:
1. V4.1.0 R3 model improvements
2. Performance comparison (V4.1 vs V4.0 vs V3.2)
3. New features added
4. Validation results
5. Updated pipeline architecture diagram
6. Quick reference for model paths

Insert after the existing V4 section or update the V4 section entirely.

Update execution log with results.

Execute now.
```

### Code to Add/Update in README.md

Add this section to the README.md (insert after existing model documentation):

```markdown
---

## V4.1.0 R3 Model - Production (Deployed 2025-12-30)

### Executive Summary

V4.1.0 R3 represents a significant upgrade to our lead scoring ML model, achieving:

| Metric | V4.0.0 (Previous) | V4.1.0 R3 (Current) | Improvement |
|--------|-------------------|---------------------|-------------|
| **Test AUC-ROC** | 0.599 | **0.620** | **+3.5%** |
| **Top Decile Lift** | 1.51x | **2.03x** | **+34.4%** |
| **Test AUC-PR** | 0.043 | **0.070** | **+62.8%** |
| **Features** | 14 | **22** | +8 new features |
| **SHAP** | Limited | **Full KernelExplainer** | ‚úÖ Enhanced |

### Why V4.1.0 R3?

**Problem with V4.0.0**: The model lacked direct bleeding signal features. It could only infer firm instability indirectly through `firm_net_change_12mo`, missing important signals like:
- How recently an advisor moved
- The velocity of firm departures (accelerating vs. decelerating)
- Whether advisors are dual-registered (more mobile)

**V4.1.0 Solution**: Added 8 new features capturing:
1. **Bleeding signals**: `is_recent_mover`, `days_since_last_move`, `firm_departures_corrected`, `bleeding_velocity_encoded`
2. **Firm/rep type**: `is_independent_ria`, `is_ia_rep_type`, `is_dual_registered`

### Feature List (22 Features)

#### Original Features (15 retained from V4.0.0)
| # | Feature | Description |
|---|---------|-------------|
| 1 | `tenure_months` | Months at current firm |
| 2 | `tenure_bucket_encoded` | Tenure category (0-5 scale) |
| 3 | `experience_years` | Total industry experience |
| 4 | `mobility_3yr` | Firm moves in last 3 years |
| 5 | `mobility_tier_encoded` | Mobility category (0-3 scale) |
| 6 | `firm_rep_count_at_contact` | Firm headcount |
| 7 | `firm_net_change_12mo` | Firm's net advisor change |
| 8 | `firm_stability_tier_encoded` | Firm bleeding category |
| 9 | `is_wirehouse` | Major wirehouse flag |
| 10 | `is_broker_protocol` | Broker Protocol participant |
| 11 | `has_email` | Email available |
| 12 | `has_linkedin` | LinkedIn available |
| 13 | `has_firm_data` | Firm data quality |
| 14 | `mobility_x_heavy_bleeding` | Interaction: mobile + bleeding firm |
| 15 | `short_tenure_x_high_mobility` | Interaction: short tenure + mobile |

#### New V4.1 Features (7 added)
| # | Feature | Description | Signal |
|---|---------|-------------|--------|
| 16 | `is_recent_mover` | Moved in last 12 months | High mobility indicator |
| 17 | `days_since_last_move` | Days since firm change | Recency signal |
| 18 | `firm_departures_corrected` | Corrected departure count | Firm instability |
| 19 | `bleeding_velocity_encoded` | 0=Stable, 3=Accelerating | Trend direction |
| 20 | `is_independent_ria` | Independent RIA flag | Firm type signal |
| 21 | `is_ia_rep_type` | IA rep type | Rep mobility pattern |
| 22 | `is_dual_registered` | Broker-dealer + IA | Higher mobility potential |

#### Removed Features (4 - multicollinearity)
| Feature | Removed Because | Correlation |
|---------|-----------------|-------------|
| `industry_tenure_months` | Redundant with `experience_years` | r = 0.96 |
| `tenure_bucket_x_mobility` | Redundant with `mobility_3yr` | r = 0.94 |
| `independent_ria_x_ia_rep` | Redundant with `is_ia_rep_type` | r = 0.97 |
| `recent_mover_x_bleeding` | Redundant with `is_recent_mover` | r = 0.90 |

### Validation Results

#### Test Set Performance
```
Test Set: 3,393 leads | 133 conversions | 3.92% conversion rate

Lift by Decile:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Decile  ‚îÇ Avg Score  ‚îÇ Conversions ‚îÇ Conv Rate ‚îÇ   Lift   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 0 (bot) ‚îÇ 0.3306     ‚îÇ 4           ‚îÇ 0.99%     ‚îÇ 0.25x    ‚îÇ
‚îÇ 1       ‚îÇ 0.3791     ‚îÇ 5           ‚îÇ 1.82%     ‚îÇ 0.46x    ‚îÇ
‚îÇ 2       ‚îÇ 0.4015     ‚îÇ 11          ‚îÇ 3.24%     ‚îÇ 0.83x    ‚îÇ
‚îÇ 3       ‚îÇ 0.4443     ‚îÇ 13          ‚îÇ 3.83%     ‚îÇ 0.98x    ‚îÇ
‚îÇ 4       ‚îÇ 0.4720     ‚îÇ 21          ‚îÇ 6.18%     ‚îÇ 1.58x    ‚îÇ
‚îÇ 5       ‚îÇ 0.4968     ‚îÇ 10          ‚îÇ 2.95%     ‚îÇ 0.75x    ‚îÇ
‚îÇ 6       ‚îÇ 0.5196     ‚îÇ 12          ‚îÇ 3.54%     ‚îÇ 0.90x    ‚îÇ
‚îÇ 7       ‚îÇ 0.5390     ‚îÇ 9           ‚îÇ 2.65%     ‚îÇ 0.68x    ‚îÇ
‚îÇ 8       ‚îÇ 0.5662     ‚îÇ 21          ‚îÇ 6.19%     ‚îÇ 1.58x    ‚îÇ
‚îÇ 9 (top) ‚îÇ 0.6193     ‚îÇ 27          ‚îÇ 7.94%     ‚îÇ 2.03x ‚≠ê ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### Validation Gates (All Passed)
| Gate | Criterion | Result | Status |
|------|-----------|--------|--------|
| G9.1 | Test AUC-ROC ‚â• 0.58 | 0.620 | ‚úÖ PASSED |
| G9.2 | Top Decile Lift ‚â• 1.4x | 2.03x | ‚úÖ PASSED |
| G9.3 | V4.1 AUC ‚â• V4.0 AUC | 0.620 > 0.599 | ‚úÖ PASSED |
| G9.4 | Bottom 20% Rate < 2% | 1.40% | ‚úÖ PASSED |
| G8.1 | Overfitting (AUC gap < 0.15) | 0.075 | ‚úÖ PASSED |

### File Reference

#### Model Files
| File | Path | Description |
|------|------|-------------|
| Model (pickle) | `v4/models/v4.1.0/model.pkl` | Trained XGBoost model |
| Model (JSON) | `v4/models/v4.1.0/model.json` | Model JSON format |
| Features | `v4/data/v4.1.0/final_features.json` | 22 feature list |
| Hyperparameters | `v4/models/v4.1.0/hyperparameters.json` | Training config |
| Feature importance | `v4/models/v4.1.0/feature_importance.csv` | SHAP + XGBoost importance |

#### Pipeline Files
| File | Path | Description |
|------|------|-------------|
| Feature SQL | `pipeline/sql/v4_prospect_features.sql` | V4.1 feature engineering (UPDATED) |
| Scoring script | `pipeline/scripts/score_prospects_monthly.py` | Monthly scoring (UPDATED) |
| Lead list SQL | `pipeline/sql/January_2026_Lead_List_V3_V4_Hybrid.sql` | Hybrid query (UPDATED) |
| Validation | Validation queries in lead list SQL | Validation queries |

#### BigQuery Tables (Same Names, Updated Contents)
| Table | Description |
|------|-------------|
| `ml_features.v4_prospect_features` | V4.1 features (22 features) |
| `ml_features.v4_prospect_scores` | V4.1 scores with percentiles |
| `ml_features.january_2026_lead_list_v4` | Final lead list with V4.1 columns |

### Monthly Execution Checklist (V4.1)

```markdown
## [MONTH] 2026 Lead List Generation (V4.1)

**Date**: YYYY-MM-DD

### Step 1: Generate V4.1 Features
- [ ] Run: pipeline/sql/v4_prospect_features.sql
- [ ] Verify: ml_features.v4_prospect_features created/updated
- [ ] Row count: __________
- [ ] Feature count: 22

### Step 2: Score Prospects
- [ ] Run: python pipeline/scripts/score_prospects_monthly.py
- [ ] Verify: ml_features.v4_prospect_scores created/updated
- [ ] Row count: __________
- [ ] Bottom 20% count: __________

### Step 3: Generate Lead List
- [ ] Run: pipeline/sql/January_2026_Lead_List_V3_V4_Hybrid.sql
- [ ] Verify: ml_features.january_2026_lead_list_v4 created/updated
- [ ] Lead count: __________
- [ ] Tier distribution validated

### Step 4: Export
- [ ] Export to CSV
- [ ] Upload to Salesforce
- [ ] Notify team
```

### Changelog

| Version | Date | Changes |
|---------|------|---------|
| V4.1.0 R3 | 2025-12-30 | Production deployment - 22 features, 0.620 AUC, 2.03x lift |
| V4.1.0 R2 | 2025-12-30 | Added regularization - overfitting controlled |
| V4.1.0 R1 | 2025-12-30 | Initial V4.1 training - 26 features |
| V4.0.0 | 2025-12-15 | Original ML model - 14 features, 0.599 AUC |
| V3.2.5 | 2025-12-01 | Rules-based tier system - production |

---
```

### Verification 5.1

```
@workspace Verify the README.md update is complete.

Check in README.md:
1. V4.1.0 R3 section exists
2. Performance comparison table present
3. Feature list (22 features) documented
4. Validation results included
5. Pipeline architecture diagram present
6. File reference table complete (shows UPDATED files)
7. Monthly checklist updated for V4.1
8. BigQuery table names shown as SAME (updated contents)

Update pipeline/logs/V4.1_INTEGRATION_LOG.md with results.
```

---

## Step 6: Update Validation Queries

### Cursor Prompt 6.1

```
@workspace Update validation queries to check existing tables with V4.1 features.

WORKING DIRECTORY: C:\Users\russe\Documents\lead_scoring_production

Task:
1. Update validation queries in the lead list SQL or create separate validation file
2. Update queries to check:
   - v4_prospect_features has 22 features (including 7 new V4.1 features)
   - v4_prospect_scores has scores from V4.1 model
   - january_2026_lead_list_v4 has new V4.1 columns
3. Update table names to use SAME names (v4_prospect_features, v4_prospect_scores, january_2026_lead_list_v4)

Update execution log with results.

Execute now.
```

### Validation Queries

Add these validation queries to verify V4.1 integration:

```sql
-- ============================================================================
-- V4.1 VALIDATION QUERIES
-- ============================================================================
-- Run these after each pipeline step to verify V4.1 integration

-- 1. Verify feature table has 22 features
SELECT 
    'Feature Count' as check_name,
    COUNT(*) as total_features
FROM (
    SELECT 
        'tenure_months' as feature_name UNION ALL
    SELECT 'tenure_bucket_encoded' UNION ALL
    SELECT 'experience_years' UNION ALL
    SELECT 'mobility_3yr' UNION ALL
    SELECT 'mobility_tier_encoded' UNION ALL
    SELECT 'firm_rep_count_at_contact' UNION ALL
    SELECT 'firm_net_change_12mo' UNION ALL
    SELECT 'firm_stability_tier_encoded' UNION ALL
    SELECT 'is_wirehouse' UNION ALL
    SELECT 'is_broker_protocol' UNION ALL
    SELECT 'has_email' UNION ALL
    SELECT 'has_linkedin' UNION ALL
    SELECT 'has_firm_data' UNION ALL
    SELECT 'mobility_x_heavy_bleeding' UNION ALL
    SELECT 'short_tenure_x_high_mobility' UNION ALL
    -- NEW V4.1 FEATURES:
    SELECT 'is_recent_mover' UNION ALL
    SELECT 'days_since_last_move' UNION ALL
    SELECT 'firm_departures_corrected' UNION ALL
    SELECT 'bleeding_velocity_encoded' UNION ALL
    SELECT 'is_independent_ria' UNION ALL
    SELECT 'is_ia_rep_type' UNION ALL
    SELECT 'is_dual_registered'
);

-- 2. Verify v4_prospect_features has new V4.1 features
SELECT 
    'v4_prospect_features' as table_name,
    COUNT(*) as total_rows,
    SUM(CASE WHEN is_recent_mover IS NOT NULL THEN 1 ELSE 0 END) as has_is_recent_mover,
    SUM(CASE WHEN days_since_last_move IS NOT NULL THEN 1 ELSE 0 END) as has_days_since_last_move,
    SUM(CASE WHEN firm_departures_corrected IS NOT NULL THEN 1 ELSE 0 END) as has_firm_departures_corrected,
    SUM(CASE WHEN bleeding_velocity_encoded IS NOT NULL THEN 1 ELSE 0 END) as has_bleeding_velocity_encoded,
    SUM(CASE WHEN is_dual_registered IS NOT NULL THEN 1 ELSE 0 END) as has_is_dual_registered
FROM `savvy-gtm-analytics.ml_features.v4_prospect_features`;

-- 3. Verify v4_prospect_scores has V4.1 scores
SELECT 
    'v4_prospect_scores' as table_name,
    COUNT(*) as total_scored,
    ROUND(AVG(v4_score), 4) as avg_score,
    ROUND(AVG(v4_percentile), 1) as avg_percentile,
    SUM(CASE WHEN v4_deprioritize = TRUE THEN 1 ELSE 0 END) as deprioritize_count
FROM `savvy-gtm-analytics.ml_features.v4_prospect_scores`;

-- 4. Verify january_2026_lead_list_v4 has new V4.1 columns
SELECT 
    'january_2026_lead_list_v4' as table_name,
    COUNT(*) as total_leads,
    SUM(CASE WHEN v4_is_recent_mover IS NOT NULL THEN 1 ELSE 0 END) as has_v4_is_recent_mover,
    SUM(CASE WHEN v4_days_since_last_move IS NOT NULL THEN 1 ELSE 0 END) as has_v4_days_since_last_move,
    SUM(CASE WHEN v4_firm_departures_corrected IS NOT NULL THEN 1 ELSE 0 END) as has_v4_firm_departures_corrected,
    SUM(CASE WHEN v4_bleeding_velocity_encoded IS NOT NULL THEN 1 ELSE 0 END) as has_v4_bleeding_velocity_encoded,
    SUM(CASE WHEN v4_is_dual_registered IS NOT NULL THEN 1 ELSE 0 END) as has_v4_is_dual_registered
FROM `savvy-gtm-analytics.ml_features.january_2026_lead_list_v4`;
```

### Verification 6.1

```
@workspace Verify validation queries are updated correctly.

Check:
1. Validation queries check existing tables (v4_prospect_features, v4_prospect_scores, january_2026_lead_list_v4)
2. Queries verify 22 features exist
3. Queries verify new V4.1 features are present
4. Table names are SAME (not v4_1_prospect_features, etc.)

Update pipeline/logs/V4.1_INTEGRATION_LOG.md with results.
```

---

## Step 7: Final Verification Checklist

### Cursor Prompt 7.1

```
@workspace Complete final verification of V4.1 integration.

WORKING DIRECTORY: C:\Users\russe\Documents\lead_scoring_production

Final verification tasks:
1. Verify all files UPDATED:
   - pipeline/sql/v4_prospect_features.sql (22 features)
   - pipeline/scripts/score_prospects_monthly.py (V4.1 paths)
   - pipeline/sql/January_2026_Lead_List_V3_V4_Hybrid.sql (V4.1 columns)
   - pipeline/January_2026_Lead_List_V3_V4_Hybrid.sql (same updates)
   - README.md (V4.1 section)

2. Verify all files CREATED:
   - pipeline/logs/V4.1_INTEGRATION_LOG.md

3. Run syntax validation on SQL files (no execution, just check)

4. Create final summary in execution log

5. Mark integration as COMPLETE

Execute now.
```

### Final Checklist

```markdown
## V4.1-R3 Integration Final Checklist

### Files Created
- [ ] pipeline/logs/V4.1_INTEGRATION_LOG.md

### Files Updated
- [ ] pipeline/sql/v4_prospect_features.sql
  - [ ] Added 8 new V4.1 features (total 22)
  - [ ] Added JOINs to inferred_departures_analysis and firm_bleeding_velocity_v41
  - [ ] Updated header comments
  - [ ] Output table: ml_features.v4_prospect_features (SAME NAME)
- [ ] pipeline/scripts/score_prospects_monthly.py
  - [ ] V4_MODEL_DIR ‚Üí v4/models/v4.1.0
  - [ ] V4_FEATURES_FILE ‚Üí v4/data/v4.1.0/final_features.json
  - [ ] FEATURES_TABLE = "v4_prospect_features" (SAME NAME)
  - [ ] SCORES_TABLE = "v4_prospect_scores" (SAME NAME)
  - [ ] Updated FEATURE_DESCRIPTIONS with new V4.1 features
- [ ] pipeline/sql/January_2026_Lead_List_V3_V4_Hybrid.sql
  - [ ] Added new V4.1 columns to v4_enriched CTE
  - [ ] Added new V4.1 columns to final SELECT
  - [ ] Updated header with V4.1 information
  - [ ] Output table: ml_features.january_2026_lead_list_v4 (SAME NAME)
- [ ] pipeline/January_2026_Lead_List_V3_V4_Hybrid.sql
  - [ ] Same updates as above (duplicate location)
- [ ] README.md
  - [ ] V4.1.0 R3 section added
  - [ ] Performance comparison table
  - [ ] Feature list (22 features)
  - [ ] File reference table (shows UPDATED files)

### SQL Validation
- [ ] v4_prospect_features.sql - No syntax errors
- [ ] January_2026_Lead_List_V3_V4_Hybrid.sql - No syntax errors

### Model Files Verified
- [ ] v4/models/v4.1.0/model.pkl exists
- [ ] v4/data/v4.1.0/final_features.json exists
- [ ] final_features.json contains 22 features

### Integration Complete
- [ ] Execution log updated with all steps
- [ ] All verification steps passed
- [ ] Ready for BigQuery execution
```

### Post-Integration Steps (Manual)

After Cursor completes the integration, manually execute:

```bash
# 1. Run feature engineering in BigQuery
# Execute: pipeline/sql/v4_prospect_features.sql
# Creates/Updates: ml_features.v4_prospect_features (22 features)

# 2. Run monthly scoring
python pipeline/scripts/score_prospects_monthly.py
# Creates/Updates: ml_features.v4_prospect_scores (V4.1 scores)

# 3. Run lead list generation
# Execute: pipeline/sql/January_2026_Lead_List_V3_V4_Hybrid.sql
# Creates/Updates: ml_features.january_2026_lead_list_v4 (with V4.1 columns)

# 4. Run validation queries (included in lead list SQL or separate)
```

---

## Appendix A: Rollback Instructions

If V4.1 integration fails or performance degrades:

### Cursor Prompt (Rollback)

```
@workspace Rollback V4.1 integration to V4.0.0.

WORKING DIRECTORY: C:\Users\russe\Documents\lead_scoring_production

Tasks:
1. Revert score_prospects_monthly.py MODEL PATHS:
   - V4_MODEL_DIR = v4/models/v4.0.0
   - V4_FEATURES_FILE = v4/data/processed/final_features.json
   - FEATURES_TABLE = "v4_prospect_features" (same)
   - SCORES_TABLE = "v4_prospect_scores" (same)

2. Note: Feature SQL can stay at 22 features (V4.0 model will just ignore extras)

3. Use existing January_2026_Lead_List_V3_V4_Hybrid.sql (revert V4.1 column additions)

4. Update execution log with rollback reason

5. Do NOT delete V4.1 files (keep for future reference)

Execute now.
```

---

## Appendix B: Support Resources

| Resource | Location |
|----------|----------|
| V4.1 Final Summary | `v4/reports/v4.1/V4.1_Final_Summary.md` |
| V4.1 Validation Report | `v4/reports/v4.1/model_validation_report_r3.md` |
| V4.1 Training Log | `v4/EXECUTION_LOG_V4.1.md` |
| V4.1 Deployment Checklist | `v4/DEPLOYMENT_CHECKLIST_V4.1.md` |
| Model Registry | `v4/models/registry.json` |
| V4.1 Production SQL Reference | `v4/sql/production_scoring_v41.sql` |

---

**Document End**

**Created**: 2025-12-30  
**Updated**: 2025-12-30  
**Purpose**: Cursor.ai automation guide for V4.1-R3 pipeline integration by **UPDATING EXISTING FILES**  
**Total Steps**: 7  
**Estimated Time**: 30-45 minutes (Cursor execution)
