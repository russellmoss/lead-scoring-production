# V4.3.0 + V3.6.0 Full Pipeline - Required Files

**Last Updated**: January 8, 2026  
**Status**: Production Ready

---

## Overview

This document lists **all required files** for a complete pipeline run of:
- **V4.3.0**: XGBoost ML model with Career Clock features (25 features)
- **V3.6.0**: Rules-based tiered scoring with Career Clock tiers (0A, 0B, 0C), Zero Friction, Sweet Spot, and M&A tiers

---

## Pipeline Execution Steps

### STEP 1: Refresh M&A Advisors Table
**Purpose**: Pre-build M&A advisor list with tier assignments

| File | Location | Status |
|------|----------|--------|
| `create_ma_eligible_advisors.sql` | `pipeline/sql/create_ma_eligible_advisors.sql` | ✅ Required |
| **Output Table**: `ml_features.ma_eligible_advisors` (~2,225 advisors) | | |

**Dependencies**:
- `ml_features.active_ma_target_firms` (M&A target firms table)
- `FinTrx_data_CA.ria_contacts_current` (advisor data)
- `FinTrx_data_CA.contact_registered_employment_history` (employment history)

---

### STEP 2: Calculate V4 Features
**Purpose**: Calculate 25 ML features for all prospects (V4.3.0)

| File | Location | Status |
|------|----------|--------|
| `v4_prospect_features.sql` | `pipeline/sql/v4_prospect_features.sql` | ✅ Required (V4.3.0) |
| **Output Table**: `ml_features.v4_prospect_features` (~285,690 prospects) | | |

**Features Included**:
- 23 features from V4.2.0 (including `age_bucket_encoded`)
- 2 new Career Clock features: `cc_is_in_move_window`, `cc_is_too_early`
- Encoded categoricals: `tenure_bucket_encoded`, `mobility_tier_encoded`, `firm_stability_tier_encoded`

**Note**: This file was updated to V4.3.0 and includes fixes for duplicate prevention (QUALIFY ROW_NUMBER on firm-level JOINs).

---

### STEP 3: Score Prospects with V4 Model
**Purpose**: Generate ML scores, percentiles, and gain-based narratives

| File | Location | Status | Notes |
|------|----------|--------|-------|
| `score_prospects_v43.py` | `pipeline/scripts/score_prospects_v43.py` | ✅ **USE THIS** | V4.3.0 compatible |
| `score_prospects_monthly.py` | `pipeline/scripts/score_prospects_monthly.py` | ⚠️ V4.2.0 only | **DO NOT USE** - outdated |

**Output Table**: `ml_features.v4_prospect_scores` (~285,690 scores)

**Model Artifacts Required**:
- `v4/models/v4.3.0/v4.3.0_model.json` - Trained XGBoost model
- `v4/models/v4.3.0/v4.3.0_feature_importance.csv` - Feature importance for narratives

**Note**: Uses gain-based narratives (SHAP deferred to V4.4.0 due to XGBoost/SHAP compatibility issue).

---

### STEP 4: Generate Base Lead List (Query 1)
**Purpose**: Standard leads with V3 tiers + V4 upgrades

| File | Location | Status |
|------|----------|--------|
| `January_2026_Lead_List_V3_V4_Hybrid.sql` | `pipeline/sql/January_2026_Lead_List_V3_V4_Hybrid.sql` | ✅ Required |
| **Output Table**: `ml_features.january_2026_lead_list` (~2,800 leads) | | |

**Dependencies**:
- `ml_features.lead_scores_v3_6` (V3.6.0 tier assignments)
- `ml_features.v4_prospect_scores` (V4.3.0 ML scores)
- `ml_features.v4_prospect_features` (V4.3.0 features)
- `ml_features.excluded_firms` (firm exclusions)
- `ml_features.excluded_firm_crds` (CRD exclusions)

**V3.6.0 Tier Logic**:
- **File**: `v3/sql/phase_4_v3_tiered_scoring.sql` (creates `ml_features.lead_scores_v3_6`)
- **Features**: `v3/sql/lead_scoring_features_pit.sql` (creates `ml_features.lead_scoring_features_pit`)

**Note**: This query creates the base lead list. M&A leads are added in STEP 5.

---

### STEP 5: Insert M&A Leads (Query 2) ⚠️ MUST RUN AFTER STEP 4
**Purpose**: Add M&A tier leads (bypasses CTE issues)

| File | Location | Status |
|------|----------|--------|
| `Insert_MA_Leads.sql` | `pipeline/sql/Insert_MA_Leads.sql` | ✅ Required |
| **Output**: Adds ~300 M&A leads to existing `ml_features.january_2026_lead_list` | | |

**Dependencies**:
- `ml_features.january_2026_lead_list` (must exist - created in STEP 4)
- `ml_features.ma_eligible_advisors` (created in STEP 1)

**Why Two Queries?**
- BigQuery CTE optimization issues prevent M&A advisors from appearing when integrated into the main query
- This separate INSERT approach guarantees M&A leads are added successfully

---

### STEP 6: Export to CSV
**Purpose**: CSV file for Salesforce import

| File | Location | Status |
|------|----------|--------|
| `export_lead_list.py` | `pipeline/scripts/export_lead_list.py` | ✅ Required |
| **Output**: `pipeline/exports/[month]_2026_lead_list_YYYYMMDD.csv` | | |

**Configuration**:
- **Input Table**: `ml_features.january_2026_lead_list`
- **Output Directory**: `pipeline/exports/`

---

## V3.6.0 Supporting Files

### V3 Tier Scoring (Required for STEP 4)

| File | Location | Purpose | Output Table |
|------|----------|---------|--------------|
| `lead_scoring_features_pit.sql` | `v3/sql/lead_scoring_features_pit.sql` | Feature engineering (37 features) | `ml_features.lead_scoring_features_pit` |
| `phase_4_v3_tiered_scoring.sql` | `v3/sql/phase_4_v3_tiered_scoring.sql` | Tier assignment logic (V3.6.0) | `ml_features.lead_scores_v3_6` |

**V3.6.0 Features**:
- Career Clock tiers (0A, 0B, 0C) - timing-aware prioritization
- Zero Friction tier (TIER_1B_PRIME_ZERO_FRICTION) - 13.64% conversion
- Sweet Spot tiers (TIER_1G_ENHANCED_SWEET_SPOT) - 9.09% conversion
- M&A tiers (TIER_MA_ACTIVE_PRIME, TIER_MA_ACTIVE) - from V3.5.0

**Note**: These tables should be refreshed periodically (monthly or when V3 logic changes).

---

## Model Artifacts Required

### V4.3.0 Model Files

| File | Location | Purpose |
|------|----------|---------|
| `v4.3.0_model.json` | `v4/models/v4.3.0/v4.3.0_model.json` | Trained XGBoost model |
| `v4.3.0_feature_importance.csv` | `v4/models/v4.3.0/v4.3.0_feature_importance.csv` | Feature importance for narratives |
| `v4.3.0_metadata.json` | `v4/models/v4.3.0/v4.3.0_metadata.json` | Training metadata |

---

## BigQuery Tables Required

### Source Tables (External)
- `FinTrx_data_CA.ria_contacts_current` - Advisor contact data
- `FinTrx_data_CA.contact_registered_employment_history` - Employment history
- `SavvyGTMData.User` - SGA user data
- `SavvyGTMData.Lead` - Salesforce lead data
- `SavvyGTMData.broker_protocol_members` - Broker protocol firms

### Intermediate Tables (Created by Pipeline)
- `ml_features.ma_eligible_advisors` - M&A eligible advisors (STEP 1)
- `ml_features.v4_prospect_features` - V4.3.0 features (STEP 2)
- `ml_features.v4_prospect_scores` - V4.3.0 scores (STEP 3)
- `ml_features.lead_scoring_features_pit` - V3 features (pre-built)
- `ml_features.lead_scores_v3_6` - V3.6.0 tier assignments (pre-built)

### Configuration Tables
- `ml_features.active_ma_target_firms` - M&A target firms
- `ml_features.excluded_firms` - Firm exclusion patterns
- `ml_features.excluded_firm_crds` - CRD exclusions
- `ml_features.firm_bleeding_corrected` - Firm bleeding data
- `ml_features.firm_bleeding_velocity_v41` - Bleeding velocity data

### Output Tables
- `ml_features.january_2026_lead_list` - Final lead list (STEP 4 + STEP 5)

---

## Execution Order Summary

```
1. create_ma_eligible_advisors.sql          → ml_features.ma_eligible_advisors
2. v4_prospect_features.sql                  → ml_features.v4_prospect_features
3. score_prospects_v43.py                   → ml_features.v4_prospect_scores
4. January_2026_Lead_List_V3_V4_Hybrid.sql  → ml_features.january_2026_lead_list (base)
5. Insert_MA_Leads.sql                      → ml_features.january_2026_lead_list (adds M&A)
6. export_lead_list.py                      → exports/[month]_2026_lead_list_YYYYMMDD.csv
```

---

## File Status Checklist

### ✅ Required Files (All Present)

- [x] `pipeline/sql/create_ma_eligible_advisors.sql`
- [x] `pipeline/sql/v4_prospect_features.sql` (V4.3.0)
- [x] `pipeline/scripts/score_prospects_v43.py` (V4.3.0)
- [x] `pipeline/sql/January_2026_Lead_List_V3_V4_Hybrid.sql` (V4.3.0)
- [x] `pipeline/sql/Insert_MA_Leads.sql`
- [x] `pipeline/scripts/export_lead_list.py`
- [x] `v3/sql/lead_scoring_features_pit.sql` (V3 features)
- [x] `v3/sql/phase_4_v3_tiered_scoring.sql` (V3.6.0 tiers)
- [x] `v4/models/v4.3.0/v4.3.0_model.json` (V4.3.0 model)
- [x] `v4/models/v4.3.0/v4.3.0_feature_importance.csv` (V4.3.0 importance)

### ⚠️ Optional/Supporting Files

- [ ] `pipeline/scripts/score_prospects_monthly.py` (V4.2.0 - **DO NOT USE**)
- [ ] `v4/models/v4.2.0/` (deprecated - V4.3.0 supersedes)

---

## Notes

1. **V4.3.0 vs V4.2.0**: Always use `score_prospects_v43.py` for V4.3.0. The `score_prospects_monthly.py` script is still configured for V4.2.0.

2. **V3.6.0**: The tiered scoring SQL (`phase_4_v3_tiered_scoring.sql`) is V3.6.0 (dated January 8, 2026). It includes Career Clock tiers (0A, 0B, 0C), Zero Friction tiers, Sweet Spot tiers, and M&A tiers from V3.5.0.

3. **Two-Query Architecture**: M&A leads MUST be inserted after the base lead list is created (STEP 5 after STEP 4). This bypasses BigQuery CTE optimization issues.

4. **Feature Table Duplicates**: The `v4_prospect_features.sql` file includes QUALIFY ROW_NUMBER() clauses to prevent duplicates from firm-level JOINs. This was fixed on January 8, 2026.

5. **Gain-Based Narratives**: V4.3.0 uses gain-based feature importance for narratives (SHAP deferred to V4.4.0 due to XGBoost/SHAP compatibility issue).

---

## Quick Reference

**For V4.3.0 scoring**: Use `score_prospects_v43.py`  
**For V4.2.0 scoring**: Use `score_prospects_monthly.py` (deprecated)  
**For V3.6.0 tiers**: Use `phase_4_v3_tiered_scoring.sql`  
**For M&A leads**: Run `Insert_MA_Leads.sql` AFTER base lead list is created

---

**Last Verified**: January 8, 2026  
**Pipeline Status**: ✅ All files present and ready for production
